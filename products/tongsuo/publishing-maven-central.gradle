// Maven Central Publishing Configuration for CI
// This file completely replaces the SDK's default publishing configuration.
// It handles everything: version override, platform detection, and publishing.
//
// Usage in CI: Just apply this file and all publishing is configured.

apply plugin: 'maven-publish'
apply plugin: 'signing'

// Capture the version from command line property
def overrideVersion = project.hasProperty('version') ? project.property('version') : null

// Override version if provided via -Pversion
// Do this immediately to override SDK's hardcoded version
if (overrideVersion) {
    project.version = overrideVersion
    println "ğŸ“¦ Version override applied: ${overrideVersion}"
}

// Override group for Maven Central
project.group = 'com.infinilabs'

// Detect current platform for classifier
def osName = System.getProperty('os.name').toLowerCase()
def osArch = System.getProperty('os.arch').toLowerCase()

def platformClassifier = ''
if (osName.contains('linux')) {
    platformClassifier = osArch.contains('aarch64') || osArch.contains('arm') ? 'linux-aarch_64' : 'linux-x86_64'
} else if (osName.contains('mac') || osName.contains('darwin')) {
    platformClassifier = osArch.contains('aarch64') || osArch.contains('arm') ? 'osx-aarch_64' : 'osx-x86_64'
} else if (osName.contains('win')) {
    platformClassifier = osArch.contains('aarch64') || osArch.contains('arm') ? 'windows-aarch_64' : 'windows-x86_64'
}

// Add -dynamic suffix if building dynamic
if (project.hasProperty('tongsuoDynamic') && project.property('tongsuoDynamic') == '1') {
    platformClassifier += '-dynamic'
}

println ""
println "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
println "Maven Central Publishing Configuration"
println "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
println "Group:      ${project.group}"
println "Artifact:   tongsuo-openjdk"
println "Version:    ${project.version}"
println "Classifier: ${platformClassifier}"
println "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
println ""

// Override SDK's publishing configuration
// Use afterEvaluate to run after SDK's build.gradle is evaluated
afterEvaluate {
    // Reconfigure the existing 'maven' publication created by SDK's publishing.gradle
    publishing {
        publications {
            // Use named() to explicitly access the existing maven publication
            // This is more reliable across different Gradle versions than maven { }
            named('maven', MavenPublication) {
                // Override group and artifact
                groupId = 'com.infinilabs'
                artifactId = 'tongsuo-openjdk'
                
                // Clear any existing artifacts to avoid duplicates
                artifacts.clear()
                
                // Main JAR with platform classifier
                artifact(tasks.jar) {
                    classifier = platformClassifier
                }
                
                // Sources JAR with platform classifier
                artifact(tasks.sourcesJar) {
                    classifier = platformClassifier + '-sources'
                }
                
                // Javadoc JAR with platform classifier
                artifact(tasks.javadocJar) {
                    classifier = platformClassifier + '-javadoc'
                }
                
                pom {
                    name = 'Tongsuo Java SDK - OpenJDK Provider'
                    description = 'Tongsuo JCE Provider for OpenJDK - A Java security provider implementation based on Tongsuo cryptographic library'
                    url = 'https://github.com/infinilabs/tongsuo-java-sdk'
                    
                    licenses {
                        license {
                            name = 'The Apache License, Version 2.0'
                            url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }
                    
                    developers {
                        developer {
                            id = 'infinilabs'
                            name = 'INFINI Labs'
                            email = 'hello@infini.ltd'
                            url = 'https://www.infinilabs.com/'
                            organization = 'INFINI Labs'
                            organizationUrl = 'https://www.infinilabs.com/'
                        }
                    }
                    
                    scm {
                        connection = 'scm:git:https://github.com/infinilabs/tongsuo-java-sdk.git'
                        developerConnection = 'scm:git:git@github.com:infinilabs/tongsuo-java-sdk.git'
                        url = 'https://github.com/infinilabs/tongsuo-java-sdk'
                    }
                }
            }
        }
        
        repositories {
            mavenLocal()
        }
    }
    
    signing {
        required { gradle.taskGraph.hasTask("publish") || gradle.taskGraph.hasTask("publishToMavenLocal") }
        
        def signingKey = System.getenv("SIGNING_KEY")
        def signingPassword = System.getenv("SIGNING_PASSWORD")
        
        if (signingKey && signingPassword) {
            useInMemoryPgpKeys(signingKey, signingPassword)
            sign publishing.publications.maven
        } else {
            logger.warn("âš ï¸  Signing credentials not found - artifacts will not be signed")
        }
    }
    
    // Ensure dependent tasks are executed
    tasks.named('publishToMavenLocal') {
        dependsOn tasks.jar, tasks.sourcesJar, tasks.javadocJar
    }
}

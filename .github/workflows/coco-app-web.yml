name: Publish Component to NPM 
defaults:
  run:
    shell: bash
env:
  NODEJS_VERSION: 24
  SEARCHCHAT-REPO-NAME: "coco-app"
  REPO_URL: "https://github.com/infinilabs/ci"

permissions:
  contents: write
  pull-requests: write
  id-token: write 

on:
  workflow_dispatch:
    inputs:
      PUBLISH_COMPONENT:
        description: 'Component to publish'
        type: choice
        options:
          - ui-web-cli
          - search-chat
        required: true
        default: search-chat
      PUBLISH_CHAT_VERSION:
        description: 'Publish Search-Chat Version (Format: x.y.z)'
        required: true
        default: "1.3.1"
      PUBLISH_CLI_VERSION:
        description: 'Publish Web-CLI Version (Format: x.y.z)'
        required: true
        default: "0.0.39"
jobs:
  build-search-chat:
    if: ${{ inputs.PUBLISH_COMPONENT == 'search-chat' }}
    env:
      PUBLISH_VERSION: ${{ inputs.PUBLISH_CHAT_VERSION  }}
      PUBLISH_COMPONENT: ${{ inputs.PUBLISH_COMPONENT  }}
      VITE_LOG_LEVEL: 'warn'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.SEARCHCHAT-REPO-NAME }} repository
        uses: actions/checkout@v4
        with: 
          repository: ${{ vars.GIT_REPO }}/${{ env.SEARCHCHAT-REPO-NAME }}
          ref: main
          path: ${{ env.SEARCHCHAT-REPO-NAME }}

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODEJS_VERSION }}

      - name: Set version for ${{ env.PUBLISH_COMPONENT }}
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: |
          version="$PUBLISH_VERSION"
          if [[ -z "$version" ]]; then
            echo "Error: PUBLISH_VERSION is required. Please specify a version in x.y.z format." >&2
            exit 1
          fi

          if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format. Expected x.y.z (e.g. 1.2.3)" >&2
            exit 1
          fi

          # Update tsup.config.ts
          sed -i "s/version:\s*\"[^\"]*\"/version: \"$version\"/" tsup.config.ts
          grep -oP 'version:\s*"\K[0-9]+\.[0-9]+\.[0-9]+' tsup.config.ts || {
            echo "Error: Failed to update version in tsup.config.ts" >&2
            exit 1
          }

          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Enable web adapter
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: |
          TARGET_FILE="src/utils/platformAdapter.ts"
          # Enable Web Adapter and disable Tauri Adapter
          sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET_FILE"
          cat "$TARGET_FILE"

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies and build web
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: pnpm install
          
      - name: Build for publish with ${{ env.VERSION }}
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        env:
          NODE_OPTIONS: "--max_old_space_size=8192"
        run: |
          echo "node version: $(node -v) and npm version: $(npm -v)"
          pnpm run build:web
          cd out/search-chat
          jq --arg url "$REPO_URL" \
            '.repository = { type: "git", url: $url }' \
            package.json > temp.json && mv temp.json package.json
          npm publish
      
      - name: Update version in coco-app-web.yml
        run: |
          FILE=".github/workflows/publish-components.yml"
          yq -i '.on.workflow_dispatch.inputs.PUBLISH_CHAT_VERSION.default = "${{ inputs.PUBLISH_CHAT_VERSION }}"' "$FILE"
          yq -i '.on.workflow_dispatch.inputs.PUBLISH_CLI_VERSION.default = "${{ inputs.PUBLISH_CLI_VERSION }}"' "$FILE"
          if [ "${{ inputs.PUBLISH_COMPONENT }}" == "search-chat" ]; then
            VERSION="${{ inputs.PUBLISH_CHAT_VERSION }}"
          else
            VERSION="${{ inputs.PUBLISH_CLI_VERSION }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ inputs.PUBLISH_COMPONENT }} default version to ${{ env.VERSION }}"
          branch: "bump/${{ inputs.PUBLISH_COMPONENT }}-v${{ env.VERSION }}"
          title: "Bump ${{ inputs.PUBLISH_COMPONENT }} default version"
          body: |
            Auto-updated default version after successful publish.
          labels: "auto-merge"
          delete-branch: true

      - name: Auto-merge the PR
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "$PR_URL" ]]; then
            echo "Auto-merging PR: $PR_URL"
            gh pr merge "$PR_URL" --auto --merge
          fi

  build-web-cli:
    if: ${{ inputs.PUBLISH_COMPONENT == 'ui-web-cli' }}
    env:
      PUBLISH_VERSION: ${{ inputs.PUBLISH_CLI_VERSION  }}
      PUBLISH_COMPONENT: ${{ inputs.PUBLISH_COMPONENT  }}
      VITE_LOG_LEVEL: 'warn'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.PUBLISH_COMPONENT }} repository
        uses: actions/checkout@v4
        with: 
          repository: ${{ vars.GIT_REPO }}/${{ env.PUBLISH_COMPONENT }}
          ref: main
          path: ${{ env.PUBLISH_COMPONENT }}
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODEJS_VERSION }}
      
      - name: Set version for ${{ env.PUBLISH_COMPONENT }}
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        run: |
          version="$PUBLISH_VERSION"
          if [[ -z "$version" ]]; then
            echo "Error: PUBLISH_VERSION is required. Please specify a version in x.y.z format." >&2
            exit 1
          fi

          if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format. Expected x.y.z (e.g. 1.2.3)" >&2
            exit 1
          fi

          # Update package.json
          tmp_file=$(mktemp)
          jq --arg v "$version" '.version = $v' package.json > "$tmp_file" && mv "$tmp_file" package.json
          if ! grep -q "\"version\": \"$version\"" package.json; then
            echo "Error: Failed to update version in package.json" >&2
            exit 1
          fi

          echo "VERSION=$version" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies and build web
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        run: pnpm install
          
      - name: Build for publish with ${{ env.VERSION }}
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        env:
          NODE_OPTIONS: "--max_old_space_size=8192"
        run: |
          echo "node version: $(node -v) and npm version: $(npm -v)"
          pnpm run build
          jq --arg url "$REPO_URL" \
            '.repository = { type: "git", url: $url }' \
            package.json > temp.json && mv temp.json package.json
          npm publish
      - name: Update version in coco-app-web.yml
        run: |
          FILE=".github/workflows/publish-components.yml"
          yq -i '.on.workflow_dispatch.inputs.PUBLISH_CHAT_VERSION.default = "${{ inputs.PUBLISH_CHAT_VERSION }}"' "$FILE"
          yq -i '.on.workflow_dispatch.inputs.PUBLISH_CLI_VERSION.default = "${{ inputs.PUBLISH_CLI_VERSION }}"' "$FILE"
          if [ "${{ inputs.PUBLISH_COMPONENT }}" == "search-chat" ]; then
            VERSION="${{ inputs.PUBLISH_CHAT_VERSION }}"
          else
            VERSION="${{ inputs.PUBLISH_CLI_VERSION }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ inputs.PUBLISH_COMPONENT }} default version to ${{ env.VERSION }}"
          branch: "bump/${{ inputs.PUBLISH_COMPONENT }}-v${{ env.VERSION }}"
          title: "Bump ${{ inputs.PUBLISH_COMPONENT }} default version"
          body: |
            Auto-updated default version after successful publish.
          labels: "auto-merge"
          delete-branch: true

      - name: Auto-merge the PR
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "$PR_URL" ]]; then
            echo "Auto-merging PR: $PR_URL"
            gh pr merge "$PR_URL" --auto --merge
          fi
        
  notify_on_failure:
    runs-on: ubuntu-latest
    needs: [build-search-chat, build-web-cli]
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Feishu Notification on Failure
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          SERVER_URL: ${{ github.server_url }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh

name: Publish Component to NPM 
defaults:
  run:
    shell: bash
env:
  CI: false
  SEARCHCHAT-REPO-NAME: "coco-app"
  NODEJS_VERSION: 24

permissions:
  contents: read
  id-token: write 

on:
  workflow_dispatch:
    inputs:
      PUBLISH_COMPONENT:
        description: 'Component to publish'
        type: choice
        options:
          - ui-web-cli
          - search-chat
        required: true
        default: search-chat
      PUBLISH_CHAT_VERSION:
        description: 'Publish Search-Chat Version (Format: x.y.z)'
        required: true
        default: "1.3.1"
      PUBLISH_CLI_VERSION:
        description: 'Publish Web-CLI Version (Format: x.y.z)'
        required: true
        default: "0.0.38"
jobs:
  build-search-chat:
    if: ${{ inputs.PUBLISH_COMPONENT == 'search-chat' }}
    env:
      PUBLISH_VERSION: ${{ inputs.PUBLISH_CHAT_VERSION  }}
      PUBLISH_COMPONENT: ${{ inputs.PUBLISH_COMPONENT  }}
      VITE_LOG_LEVEL: 'warn'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.SEARCHCHAT-REPO-NAME }} repository
        uses: actions/checkout@v4
        with: 
          repository: ${{ vars.GIT_REPO }}/${{ env.SEARCHCHAT-REPO-NAME }}
          ref: main
          path: ${{ env.SEARCHCHAT-REPO-NAME }}

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Set version for ${{ env.PUBLISH_COMPONENT }}
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: |
          version="$PUBLISH_VERSION"
          if [[ -z "$version" ]]; then
            echo "Error: PUBLISH_VERSION is required. Please specify a version in x.y.z format." >&2
            exit 1
          fi

          if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format. Expected x.y.z (e.g. 1.2.3)" >&2
            exit 1
          fi

          # Update tsup.config.ts
          sed -i "s/version:\s*\"[^\"]*\"/version: \"$version\"/" tsup.config.ts
          grep -oP 'version:\s*"\K[0-9]+\.[0-9]+\.[0-9]+' tsup.config.ts || {
            echo "Error: Failed to update version in tsup.config.ts" >&2
            exit 1
          }

          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Enable web adapter
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: |
          TARGET_FILE="src/utils/platformAdapter.ts"
          # Enable Web Adapter and disable Tauri Adapter
          sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET_FILE"
          cat "$TARGET_FILE"

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies and build web
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        run: pnpm install
          
      - name: Build for publish with ${{ env.VERSION }}
        working-directory: ${{ env.SEARCHCHAT-REPO-NAME }}
        env:
          NODE_OPTIONS: "--max_old_space_size=8192"
        run: |
          pnpm run build:web && cd out/search-chat && npm publish --provenance --access public

  build-web-cli:
    if: ${{ inputs.PUBLISH_COMPONENT == 'ui-web-cli' }}
    env:
      PUBLISH_VERSION: ${{ inputs.PUBLISH_CLI_VERSION  }}
      PUBLISH_COMPONENT: ${{ inputs.PUBLISH_COMPONENT  }}
      VITE_LOG_LEVEL: 'warn'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.PUBLISH_COMPONENT }} repository
        uses: actions/checkout@v4
        with: 
          repository: ${{ vars.GIT_REPO }}/${{ env.PUBLISH_COMPONENT }}
          ref: main
          path: ${{ env.PUBLISH_COMPONENT }}
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          registry-url: 'https://registry.npmjs.org'
      
      - name: Set version for ${{ env.PUBLISH_COMPONENT }}
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        run: |
          version="$PUBLISH_VERSION"
          if [[ -z "$version" ]]; then
            echo "Error: PUBLISH_VERSION is required. Please specify a version in x.y.z format." >&2
            exit 1
          fi

          if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format. Expected x.y.z (e.g. 1.2.3)" >&2
            exit 1
          fi

          # Update package.json
          tmp_file=$(mktemp)
          jq --arg v "$version" '.version = $v' package.json > "$tmp_file" && mv "$tmp_file" package.json
          if ! grep -q "\"version\": \"$version\"" package.json; then
            echo "Error: Failed to update version in package.json" >&2
            exit 1
          fi

          echo "VERSION=$version" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies and build web
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        run: pnpm install
          
      - name: Build for publish with ${{ env.VERSION }}
        working-directory: ${{ env.PUBLISH_COMPONENT }}
        env:
          NODE_OPTIONS: "--max_old_space_size=8192"
        run: |
          pnpm run build && npm publish --provenance --access public

  notify_on_failure:
    runs-on: ubuntu-latest
    needs: [build-search-chat, build-web-cli]
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send Feishu Notification on Failure
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          SERVER_URL: ${{ github.server_url }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh

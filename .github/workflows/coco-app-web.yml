name: Publish Component to NPM 
defaults:
  run:
    shell: bash
env:
  NODEJS_VERSION: 24
  REPO_URL: "https://github.com/infinilabs/ci"
  NPM_REGISTRY: "https://registry.npmjs.org"
  WORKFLOW_FILE: ".github/workflows/coco-app-web.yml"
  NODE_OPTIONS: "--max_old_space_size=8192"

permissions:
  contents: write
  pull-requests: write
  id-token: write 

on:
  workflow_dispatch:
    inputs:
      PUBLISH_COMPONENT:
        description: 'Component to publish'
        type: choice
        options:
          - ui-web-cli
          - search-chat
          # new-component
        required: true
        default: search-chat
      
      PUBLISH_CHAT_VERSION:
        description: 'Search-Chat Version'
        required: true
        default: "1.3.1"
      PUBLISH_CLI_VERSION:
        description: 'Web-CLI Version'
        required: true
        default: "0.0.39"
      # new-component: PUBLISH_NEW_VERSION ...

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
      COMPONENT: ${{ inputs.PUBLISH_COMPONENT }}

    steps:
      - name: Generate configuration for ${{ env.COMPONENT }}
        id: config
        run: |
          # config map for components
          CONFIG_JSON='{
            "search-chat": {
              "repo_name": "coco-app",
              "input_key": "PUBLISH_CHAT_VERSION",
              "build_cmd": "pnpm run build:web",
              "dist_dir": "out/search-chat",
              "use_ssh": false,
              "version_file": "tsup",
              "adapter_script": true
            },
            "ui-web-cli": {
              "repo_name": "ui-web-cli",
              "input_key": "PUBLISH_CLI_VERSION",
              "build_cmd": "pnpm run build",
              "dist_dir": ".",
              "use_ssh": true,
              "version_file": "package.json",
              "adapter_script": false
            }
          }'

          # 1. get repo name and input key from config
          REPO_NAME=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].repo_name")
          INPUT_KEY=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].input_key")
          
          if [[ "$REPO_NAME" == "null" ]]; then
            echo "Error: Configuration for component '$COMPONENT' not found."
            exit 1
          fi

          # 2. get version from inputs
          VERSION=$(echo "$INPUTS_JSON" | jq -r ".[\"$INPUT_KEY\"]")

          # 3. get other config values
          BUILD_CMD=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].build_cmd")
          DIST_DIR=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].dist_dir")
          USE_SSH=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].use_ssh")
          VERSION_FILE=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].version_file")
          ADAPTER=$(echo "$CONFIG_JSON" | jq -r ".[\"$COMPONENT\"].adapter_script")

          # 4. write to env
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "INPUT_KEY=$INPUT_KEY" >> $GITHUB_ENV
          echo "BUILD_CMD=$BUILD_CMD" >> $GITHUB_ENV
          echo "DIST_DIR=$DIST_DIR" >> $GITHUB_ENV
          echo "USE_SSH=$USE_SSH" >> $GITHUB_ENV
          echo "VERSION_FILE=$VERSION_FILE" >> $GITHUB_ENV
          echo "ADAPTER=$ADAPTER" >> $GITHUB_ENV

          echo "::notice title=Config Loaded::Component: $COMPONENT | Version: $VERSION | Repo: $REPO_NAME"

      - name: Checkout ci repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.REPO_NAME }} repository
        uses: actions/checkout@v4
        with: 
          repository: ${{ vars.GIT_REPO }}/${{ env.REPO_NAME }}
          ref: main
          path: ${{ env.REPO_NAME }}
          ssh-key: ${{ env.USE_SSH == 'true' && secrets.SSH_PRIVATE_KEY || '' }}

      - name: Setup node-${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
      
      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Validate and set version for ${{ env.COMPONENT }} - ${{ env.VERSION }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          if [[ -z "$VERSION" ]] || ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format '$VERSION'." >&2; exit 1
          fi
          
          echo "Setting version to $VERSION..."

          if [[ "$VERSION_FILE" == "tsup" ]]; then
            sed -i "s/version:\s*\"[^\"]*\"/version: \"$VERSION\"/" tsup.config.ts
            grep -oP 'version:\s*"\K[0-9]+\.[0-9]+\.[0-9]+' tsup.config.ts
          else
            tmp=$(mktemp)
            jq --arg v "$VERSION" '.version = $v' package.json > "$tmp" && mv "$tmp" package.json
            grep "\"version\": \"$VERSION\"" package.json
          fi

      - name: Enable web adapter (conditional)
        if: ${{ env.ADAPTER == 'true' }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          TARGET="src/utils/platformAdapter.ts"
          [ -f "$TARGET" ] && sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET" || echo "Skip adapter"

      - name: Install dependencies for ${{ env.COMPONENT }} - ${{ env.VERSION }}
        working-directory: ${{ env.REPO_NAME }}
        run: pnpm install

      - name: Build ${{ env.COMPONENT }} - ${{ env.VERSION }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          echo "Running build: $BUILD_CMD"
          eval "$BUILD_CMD"

      - name: Inject Repository & Publish for ${{ env.COMPONENT}} - ${{ env.VERSION }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          cd ${{ env.DIST_DIR }}
          
          tmp=$(mktemp)
          jq --arg url "$REPO_URL" '.repository = { type: "git", url: $url }' package.json > "$tmp" && mv "$tmp" package.json
          
          echo "Publishing to NPM..."
          npm publish --provenance --access public

      - name: Cleanup external repos
        run: |
          echo "Cleaning up external repositories..."
          rm -rf ${{ env.REPO_NAME }}
          git status
          
      - name: Update workflow default version
        run: |
          FILE="$GITHUB_WORKSPACE/$WORKFLOW_FILE"
          # e.g: .on.workflow_dispatch.inputs.PUBLISH_CHAT_VERSION.default = "1.3.2"
          yq -i ".on.workflow_dispatch.inputs.${{ env.INPUT_KEY }}.default = \"${{ env.VERSION }}\"" "$FILE"

      - name: Create pull request for version bump of ${{ env.COMPONENT }} - ${{ env.VERSION }}
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.REPO_PAT }}
          commit-message: "chore: release ${{ env.COMPONENT }} v${{ env.VERSION }}"
          branch: "release/${{ env.COMPONENT }}-v${{ env.VERSION }}"
          title: "Release: ${{ env.COMPONENT }} v${{ env.VERSION }}"
          body: |
            Automated release for ${{ env.COMPONENT }}.
            Version bumped to ${{ env.VERSION }}.
          labels: "auto-merge, automated"
          delete-branch: true

      - name: Auto-merge the pr
        if: ${{ steps.create-pr.outputs.pull-request-url }}
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: gh pr merge "$PR_URL" --auto --merge

  notify_on_failure:
    runs-on: ubuntu-latest
    needs: [build-and-publish]
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Feishu Notification on Failure
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          SERVER_URL: ${{ github.server_url }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh

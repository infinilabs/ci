name: Publish Component to NPM
defaults:
  run:
    shell: bash
env:
  NODEJS_VERSION: 24
  REPO_URL: "https://github.com/infinilabs/ci"
  NPM_REGISTRY: "https://registry.npmjs.org"
  WORKFLOW_FILE: ".github/workflows/coco-app-web.yml"
  CONFIG_FILE: "configs/components.json"
  NODE_OPTIONS: "--max_old_space_size=8192"
permissions:
  contents: write
  pull-requests: write
  id-token: write
on:
  workflow_dispatch:
    inputs:
      # --- Only Version Inputs Needed ---
      # Logic: If the input value is different from 'current_version' in json, it triggers a publish.
      CHAT_VERSION:
        description: 'Search-Chat Version'
        required: true
        default: "1.3.7"
      CLI_VERSION:
        description: 'Web-CLI Version'
        required: true
        default: "0.0.41"
      FILTER_VERSION:
        description: 'Filter Version'
        required: true
        default: "0.0.7"
jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_components: ${{ steps.set-matrix.outputs.has_components }}
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4
      - name: Prepare Build Matrix
        id: set-matrix
        run: "if [[ ! -f \"$CONFIG_FILE\" ]]; then echo \"Error: $CONFIG_FILE not found\"; exit 1; fi\n\n# Read the entire config\nCONFIG_CONTENT=$(cat \"$CONFIG_FILE\")\n\n# Get all component names\nALL_COMPONENTS=$(echo \"$CONFIG_CONTENT\" | jq -r 'keys[]')\n\nSELECTED_COMPONENTS=()\n\necho \"Checking version changes...\"\n\nfor comp in $ALL_COMPONENTS; do\n  # 1. Get the input key defined in JSON (e.g., CHAT_VERSION)\n  INPUT_KEY=$(echo \"$CONFIG_CONTENT\" | jq -r --arg c \"$comp\" '.[$c].input_key')\n  \n  # 2. Get the current version stored in JSON\n  CURRENT_VER=$(echo \"$CONFIG_CONTENT\" | jq -r --arg c \"$comp\" '.[$c].current_version')\n  \n  # 3. Get the user input version\n  INPUT_VER=$(echo \"$INPUTS_JSON\" | jq -r --arg k \"$INPUT_KEY\" '.[$k]')\n  \n  echo \"  Component: $comp\"\n  echo \"    - Current Version (Config): $CURRENT_VER\"\n  echo \"    - Input Version (User):     $INPUT_VER\"\n\n  # 4. Compare: If input differs from current config, add to matrix\n  if [[ \"$INPUT_VER\" != \"$CURRENT_VER\" ]]; then\n    echo \"    -> CHANGED. Adding to build queue.\"\n    SELECTED_COMPONENTS+=(\"$comp\")\n  else\n    echo \"    -> UNCHANGED. Skipping.\"\n  fi\ndone\n\nif [ ${#SELECTED_COMPONENTS[@]} -eq 0 ]; then\n  echo \"::warning::No version changes detected. Nothing to publish.\"\n  echo \"has_components=false\" >> $GITHUB_OUTPUT\n  echo \"matrix=[]\" >> $GITHUB_OUTPUT\nelse\n  # Generate JSON array: [\"search-chat\", \"filter\"]\n  MATRIX_JSON=$(printf '%s\\n' \"${SELECTED_COMPONENTS[@]}\" | jq -R . | jq -s -c .)\n  echo \"Final Matrix: $MATRIX_JSON\"\n  echo \"has_components=true\" >> $GITHUB_OUTPUT\n  echo \"matrix=$MATRIX_JSON\" >> $GITHUB_OUTPUT\nfi\n"
  build-and-publish:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.has_components == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
      COMPONENT: ${{ matrix.component }}
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4
      - name: Load configuration for ${{ env.COMPONENT }}
        id: config
        run: |
          CONFIG_CONTENT=$(cat "$CONFIG_FILE")

          # Extract dynamic config
          REPO_NAME=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].repo_name')
          INPUT_KEY=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].input_key')

          # Get version from inputs
          VERSION=$(echo "$INPUTS_JSON" | jq -r --arg k "$INPUT_KEY" '.[$k]')

          # Extract other params
          WORK_DIR=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].work_dir')
          DIST_DIR=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].dist_dir')
          BUILD_CMD=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].build_cmd')
          PUBLISH_CMD=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].publish_cmd')
          REPO_PRIVATE=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].repo_private')
          VERSION_FILE=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].version_file')
          ADAPTER=$(echo "$CONFIG_CONTENT" | jq -r --arg c "$COMPONENT" '.[$c].adapter_script')

          # Export
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "INPUT_KEY=$INPUT_KEY" >> $GITHUB_ENV
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV
          echo "DIST_DIR=$DIST_DIR" >> $GITHUB_ENV
          echo "BUILD_CMD=$BUILD_CMD" >> $GITHUB_ENV
          echo "PUBLISH_CMD=$PUBLISH_CMD" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "REPO_PRIVATE=$REPO_PRIVATE" >> $GITHUB_ENV
          echo "VERSION_FILE=$VERSION_FILE" >> $GITHUB_ENV
          echo "ADAPTER=$ADAPTER" >> $GITHUB_ENV

          echo "::notice title=Config::Component: $COMPONENT | Version: $VERSION | Repo: $REPO_NAME"
      - name: Checkout ${{ env.REPO_NAME }} repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.GIT_REPO }}/${{ env.REPO_NAME }}
          ref: main
          path: ${{ env.REPO_NAME }}
          ssh-key: ${{ env.REPO_PRIVATE == 'true' && secrets.SSH_PRIVATE_KEY || '' }}
      - name: Setup node-${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Validate and Set Version
        working-directory: ${{ env.REPO_NAME }}
        run: |
          if [[ -z "$VERSION" ]] || ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format '$VERSION'." >&2; exit 1
          fi
          cd ${{ env.WORK_DIR }}
          echo "Setting version to $COMPONENT@$VERSION in $VERSION_FILE"

          if [[ "$VERSION_FILE" == "tsup.config.ts" ]]; then
            sed -i "s/version:\s*\"[^\"]*\"/version: \"$VERSION\"/" $VERSION_FILE
            grep -oP 'version:\s*"\K[0-9]+\.[0-9]+\.[0-9]+' $VERSION_FILE
          else
            tmp=$(mktemp) && \
            jq --arg v "$VERSION" --arg url "$REPO_URL" \
              '.version = $v | .repository = { type: "git", url: $url }' \
              package.json > "$tmp" && \
            mv "$tmp" package.json
            grep -oP '"version":\s*"\K[0-9]+\.[0-9]+\.[0-9]+' $VERSION_FILE
          fi
      - name: Enable web adapter (conditional)
        if: ${{ env.ADAPTER == 'true' }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          TARGET="src/utils/platformAdapter.ts"
          [ -f "$TARGET" ] && sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET" || echo "Skip adapter"
          echo "Adapter script applied to $TARGET"
      - name: Install Dependencies
        working-directory: ${{ env.REPO_NAME }}
        run: cd ${{ env.WORK_DIR }} && pnpm install
      - name: Build
        working-directory: ${{ env.REPO_NAME }}
        run: |
          cd ${{ env.WORK_DIR }}
          echo "Running build $COMPONENT@$VERSION by $BUILD_CMD"
          eval "$BUILD_CMD"
      - name: Publish
        working-directory: ${{ env.REPO_NAME }}
        run: |
          cd ${{ env.DIST_DIR }}

          # Re-inject repo URL (overwrite safe)
          tmp=$(mktemp)
          jq --arg url "$REPO_URL" '.repository = { type: "git", url: $url }' package.json > "$tmp" && mv "$tmp" package.json

          echo "Publishing $COMPONENT@$VERSION by $PUBLISH_CMD"
          eval "$PUBLISH_CMD"
      # --- Save Release Info for Summary Job ---
      # We need to save the new version so we can update both components.json and workflow.yml
      - name: Save Release Info
        run: |
          mkdir -p release_info
          # Content: search-chat|CHAT_VERSION|1.3.7
          echo "${{ env.COMPONENT }}|${{ env.INPUT_KEY }}|${{ env.VERSION }}" > release_info/${{ env.COMPONENT }}.txt
      - name: Upload Release Info
        uses: actions/upload-artifact@v4
        with:
          name: release-info-${{ env.COMPONENT }}
          path: release_info/*.txt
          retention-days: 1
  update-workflow:
    needs: build-and-publish
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4
      - name: Download all release infos
        uses: actions/download-artifact@v4
        with:
          path: all_releases
          pattern: release-info-*
          merge-multiple: true
      - name: Update configuration and workflow
        id: update
        run: "WORKFLOW_PATH=\"$GITHUB_WORKSPACE/$WORKFLOW_FILE\"\nCONFIG_PATH=\"$GITHUB_WORKSPACE/$CONFIG_FILE\"\n\nUPDATES_COUNT=0\n\nfor f in all_releases/*.txt; do\n  if [[ -f \"$f\" ]]; then\n    line=$(cat \"$f\")\n    # Parse pipe-separated values\n    COMP=$(echo \"$line\" | cut -d'|' -f1)\n    KEY=$(echo \"$line\" | cut -d'|' -f2)\n    VER=$(echo \"$line\" | cut -d'|' -f3)\n    \n    echo \"Processing Update: $COMP -> $VER\"\n    \n    # 1. Update workflow.yml default value (UI)\n    yq -i \".on.workflow_dispatch.inputs.$KEY.default = \\\"$VER\\\"\" \"$WORKFLOW_PATH\"\n    \n    # 2. Update components.json current_version (Logic)\n    # Use a temporary file for jq manipulation\n    tmp=$(mktemp)\n    jq --arg c \"$COMP\" --arg v \"$VER\" '.[$c].current_version = $v' \"$CONFIG_PATH\" > \"$tmp\" && mv \"$tmp\" \"$CONFIG_PATH\"\n    \n    UPDATES_COUNT=$((UPDATES_COUNT+1))\n  fi\ndone\n\nif [[ $UPDATES_COUNT -gt 0 ]]; then\n   echo \"has_updates=true\" >> $GITHUB_OUTPUT\nelse\n   echo \"has_updates=false\" >> $GITHUB_OUTPUT\nfi\n"
      - name: Create combined pull request
        if: ${{ steps.update.outputs.has_updates == 'true' }}
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.REPO_PAT }}
          commit-message: "chore: update versions after release"
          branch: "release/batch-update-${{ github.run_id }}"
          title: "chore: batch update component versions"
          body: "Automated update for component versions in workflow and config."
          labels: |
            auto-merge
            automated
          delete-branch: true
          add-paths: |
            ${{ env.WORKFLOW_FILE }}
            ${{ env.CONFIG_FILE }}
      - name: Auto-merge the pr
        if: ${{ steps.create-pr.outputs.pull-request-url }}
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: gh pr merge "$PR_URL" --auto --merge
  notify_final:
    runs-on: ubuntu-latest
    if: always()
    needs: [update-workflow, build-and-publish]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Send Feishu Notification
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          SERVER_URL: ${{ github.server_url }}
          STATUS: ${{ needs.update-workflow.result == 'skipped' && needs.build-and-publish.result || needs.update-workflow.result }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh

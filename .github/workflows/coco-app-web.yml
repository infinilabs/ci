name: Publish Component to NPM
defaults:
  run:
    shell: bash
env:
  NODEJS_VERSION: 24
  REPO_URL: "https://github.com/infinilabs/ci"
  NPM_REGISTRY: "https://registry.npmjs.org"
  WORKFLOW_FILE: ".github/workflows/coco-app-web.yml"
  CONFIG_FILE: "configs/components.json"
  NODE_OPTIONS: "--max_old_space_size=8192"

permissions:
  contents: write
  pull-requests: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      # --- Component 1: Search Chat ---
      PUBLISH_SEARCH_CHAT:
        description: 'Publish search-chat?'
        type: boolean
        default: false
      PUBLISH_SEARCH_CHAT_VERSION:
        description: 'Search Chat Version'
        required: true
        default: "1.3.6"

      # --- Component 2: Web CLI ---
      PUBLISH_UI_WEB_CLI:
        description: 'Publish ui-web-cli?'
        type: boolean
        default: false
      PUBLISH_CLI_VERSION:
        description: 'CLI Version'
        required: true
        default: "0.0.41"

      # --- Component 3: Filter ---
      PUBLISH_FILTER:
        description: 'Publish filter?'
        type: boolean
        default: false
      PUBLISH_FILTER_VERSION:
        description: 'Filter Version'
        required: true
        default: "0.0.6"

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_components: ${{ steps.set-matrix.outputs.has_components }}
    steps:
      - id: set-matrix
        run: |
          COMPONENTS=()
          
          if [[ "${{ inputs.PUBLISH_SEARCH_CHAT }}" == "true" ]]; then COMPONENTS+=("search-chat"); fi
          if [[ "${{ inputs.PUBLISH_UI_WEB_CLI }}" == "true" ]]; then COMPONENTS+=("ui-web-cli"); fi
          if [[ "${{ inputs.PUBLISH_FILTER }}" == "true" ]]; then COMPONENTS+=("filter"); fi
          
          if [ ${#COMPONENTS[@]} -eq 0 ]; then
            echo "has_components=false" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            MATRIX_JSON=$(printf '%s\n' "${COMPONENTS[@]}" | jq -R . | jq -s -c .)
            echo "has_components=true" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi

  build-and-publish:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.has_components == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
      COMPONENT: ${{ matrix.component }}
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4

      - name: Load Config for ${{ env.COMPONENT }}
        id: config
        run: |
          if [[ ! -f "$CONFIG_FILE" ]]; then echo "Error: Config file '$CONFIG_FILE' not found!"; exit 1; fi
          
          CONFIG_CONTENT=$(cat "$CONFIG_FILE")
          
          REPO_NAME=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].repo_name")
          REPO_PRIVATE=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].repo_private")
          INPUT_KEY=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].input_key")
          
          if [[ "$REPO_NAME" == "null" ]]; then echo "Error: Component '$COMPONENT' not found."; exit 1; fi

          # Get version from input
          VERSION=$(echo "$INPUTS_JSON" | jq -r ".[\"$INPUT_KEY\"]")

          WORK_DIR=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].work_dir")
          DIST_DIR=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].dist_dir")
          BUILD_CMD=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].build_cmd")
          PUBLISH_CMD=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].publish_cmd")
          VERSION_FILE=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].version_file")
          ADAPTER=$(echo "$CONFIG_CONTENT" | jq -r ".[\"$COMPONENT\"].adapter_script")

          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "REPO_PRIVATE=$REPO_PRIVATE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "INPUT_KEY=$INPUT_KEY" >> $GITHUB_ENV
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV
          echo "DIST_DIR=$DIST_DIR" >> $GITHUB_ENV
          echo "BUILD_CMD=$BUILD_CMD" >> $GITHUB_ENV
          echo "PUBLISH_CMD=$PUBLISH_CMD" >> $GITHUB_ENV
          echo "VERSION_FILE=$VERSION_FILE" >> $GITHUB_ENV
          echo "ADAPTER=$ADAPTER" >> $GITHUB_ENV

          echo "::notice title=Config::Component: $COMPONENT | Version: $VERSION | Repo: $REPO_NAME"

      - name: Checkout ${{ env.REPO_NAME }} repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.GIT_REPO }}/${{ env.REPO_NAME }}
          ref: main
          path: ${{ env.REPO_NAME }}
          ssh-key: ${{ env.REPO_PRIVATE == 'true' && secrets.SSH_PRIVATE_KEY || '' }}

      - name: Setup node-${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Validate and set version
        working-directory: ${{ env.REPO_NAME }}
        run: |
          if [[ -z "$VERSION" ]] || ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format '$VERSION'." >&2; exit 1
          fi
          cd ${{ env.WORK_DIR }}
          echo "Setting version to $VERSION..."

          if [[ "$VERSION_FILE" == "tsup" ]]; then
            sed -i "s/version:\s*\"[^\"]*\"/version: \"$VERSION\"/" tsup.config.ts
            grep -oP 'version:\s*"\K[0-9]+\.[0-9]+\.[0-9]+' tsup.config.ts
          else
            tmp=$(mktemp) && \
            jq --arg v "$VERSION" --arg url "$REPO_URL" \
              '.version = $v | .repository = { type: "git", url: $url }' \
              package.json > "$tmp" && \
            mv "$tmp" package.json
          fi

      - name: Enable web adapter (conditional)
        if: ${{ env.ADAPTER == 'true' }}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          TARGET="src/utils/platformAdapter.ts"
          [ -f "$TARGET" ] && sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET" || echo "Skip adapter"

      - name: Install dependencies
        working-directory: ${{ env.REPO_NAME }}
        run: cd ${{ env.WORK_DIR }} && pnpm install

      - name: Build
        working-directory: ${{ env.REPO_NAME }}
        run: cd ${{ env.WORK_DIR }} && eval "$BUILD_CMD"

      - name: Publish
        working-directory: ${{ env.REPO_NAME }}
        run: |
          cd ${{ env.DIST_DIR }}
          if grep -q "$url" package.json; then
            echo "Repository URL already set."
          else
            echo "Setting repository URL in package.json..."
            tmp=$(mktemp)
            jq --arg url "$REPO_URL" '.repository = { type: "git", url: $url }' package.json > "$tmp" && mv "$tmp" package.json
          fi

          echo "Publishing $COMPONENT@$VERSION to NPM..."
          eval "$PUBLISH_CMD"

      - name: Save Release Info
        run: |
          mkdir -p release_info
          # Format: INPUT_KEY=VERSION
          echo "${{ env.INPUT_KEY }}=${{ env.VERSION }}" > release_info/${{ env.COMPONENT }}.txt
          # Also save description key if you want to update description dynamically (harder)
          
      - name: Upload Release Info
        uses: actions/upload-artifact@v4
        with:
          name: release-info-${{ env.COMPONENT }}
          path: release_info/*.txt
          retention-days: 1

  # Job 3: Update Workflow (Serial) - Single Commit
  update-workflow:
    needs: build-and-publish
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4

      - name: Download all release infos
        uses: actions/download-artifact@v4
        with:
          path: all_releases
          pattern: release-info-*
          merge-multiple: true

      - name: Update Workflow File
        run: |
          FILE="$GITHUB_WORKSPACE/$WORKFLOW_FILE"
          
          # Iterate all success components
          for f in all_releases/*.txt; do
            if [[ -f "$f" ]]; then
              line=$(cat "$f")
              key=$(echo "$line" | cut -d'=' -f1)
              val=$(echo "$line" | cut -d'=' -f2)
              
              echo "Updating default value for input: $key -> $val"
              
              # Update default value
              yq -i ".on.workflow_dispatch.inputs.$key.default = \"$val\"" "$FILE"
            fi
          done

      - name: Create Combined Pull Request
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.REPO_PAT }}
          commit-message: "chore: update component versions after release"
          branch: "release/batch-update-${{ github.run_id }}"
          title: "chore: batch update component versions"
          body: "Automated update for component versions in workflow file."
          labels: |
            auto-merge
            automated
          delete-branch: true
          add-paths: |
            .github/workflows/*.yml

      - name: Auto-merge the pr
        if: ${{ steps.create-pr.outputs.pull-request-url }}
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: gh pr merge "$PR_URL" --auto --merge

  notify_after_publish:
    runs-on: ubuntu-latest
    if: always()
    needs: [build-and-publish, update-workflow]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Send Feishu Notification
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          SERVER_URL: ${{ github.server_url }}
          STATUS: ${{ needs.update-workflow.result }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh
name: Publish Component to NPM
defaults:
  run:
    shell: bash
env:
  NODEJS_VERSION: 24
  REPO_URL: "https://github.com/infinilabs/ci"
  NPM_REGISTRY: "https://registry.npmjs.org"
  WORKFLOW_FILE: ".github/workflows/coco-app-web.yml"
  CONFIG_FILE: "configs/components.json"
  NODE_OPTIONS: "--max_old_space_size=8192"

permissions:
  contents: write
  pull-requests: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      # --- Component Versions (Change value to trigger publish) ---
      SEARCH_CHAT_VERSION: { description: 'search-chat Version', required: true, default: "1.3.10" }
      UI_WEB_CLI_VERSION: { description: 'ui-web-cli Version', required: true, default: "0.0.43" }
      FILTER_VERSION: { description: 'filter Version', required: true, default: "0.0.10" }
      SEARCH_RESULTS_VERSION: { description: 'search-results Version', required: true, default: "0.0.7" }
      ENTITY_UI_VERSION: { description: 'entity-ui Version', required: true, default: "0.0.10" }
      CUSTOM_ICONS_VERSION: { description: 'custom-icons Version', required: true, default: "0.0.10" }
      DROPDOWNLIST_VERSION: { description: 'dropdownlist Version', required: true, default: "1.3.5" }
      DATEPICKER_VERSION: { description: 'datepicker Version', required: true, default: "0.0.10" }

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_repos: ${{ steps.set-matrix.outputs.has_repos }}
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4
      - name: Generate publish matrix
        id: set-matrix
        run: |
          echo "Generating publish matrix..."
          if [[ ! -f "$CONFIG_FILE" ]]; then echo "Error: Config not found"; exit 1; fi
          CONFIG=$(cat "$CONFIG_FILE")
          REPOS=$(echo "$CONFIG" | jq -r 'keys[]')
          
          declare -A REPO_GROUPS
          HAS_CHANGES=false

          echo "Checking version changes..."

          for repo in $REPOS; do
            COMPS=$(echo "$CONFIG" | jq -r --arg r "$repo" '.[$r].components | keys[]')
            
            for comp in $COMPS; do
              # Naming Convention: search-chat -> SEARCH_CHAT_VERSION
              SAFE_NAME=$(echo "$comp" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
              INPUT_KEY="${SAFE_NAME}_VERSION"
              
              # Get Versions (Current from JSON, Input from Dispatch)
              CURRENT_VER=$(echo "$CONFIG" | jq -r --arg r "$repo" --arg c "$comp" '.[$r].components[$c].current_version')
              INPUT_VER=$(echo "$INPUTS_JSON" | jq -r --arg k "$INPUT_KEY" '.[$k]')

              # Compare
              if [[ "$INPUT_VER" != "$CURRENT_VER" && "$INPUT_VER" != "null" ]]; then
                echo "  [+] $comp ($repo): $CURRENT_VER -> $INPUT_VER"
                HAS_CHANGES=true
                if [[ -z "${REPO_GROUPS[$repo]}" ]]; then
                  REPO_GROUPS[$repo]="$comp"
                else
                  REPO_GROUPS[$repo]="${REPO_GROUPS[$repo]} $comp"
                fi
              else
                echo "  [.] $comp: Unchanged"
              fi
            done
          done

          if [[ "$HAS_CHANGES" == "false" ]]; then
            echo "has_repos=false" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # Build Matrix: [{ "repo": "ui-common", "components": "filter search-results" }, ...]
            MATRIX_ARRAY=()
            for repo in "${!REPO_GROUPS[@]}"; do
              comps="${REPO_GROUPS[$repo]}"
              ITEM=$(jq -n --arg r "$repo" --arg c "$comps" '{repo: $r, components: $c}')
              MATRIX_ARRAY+=("$ITEM")
            done
            MATRIX_JSON=$(printf '%s\n' "${MATRIX_ARRAY[@]}" | jq -s -c .)
            
            echo -e "\nFinal Matrix: " && echo "$MATRIX_JSON" | jq '.[]'
            echo "has_repos=true" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.has_repos == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    env:
      INPUTS_JSON: ${{ toJson(inputs) }}
      REPO_NAME: ${{ matrix.repo }}
      COMPONENTS: ${{ matrix.components }}
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4

      - name: Load repo config
        run: |
          CONFIG=$(cat "$CONFIG_FILE")
          REPO_PRIVATE=$(echo "$CONFIG" | jq -r --arg r "$REPO_NAME" '.[$r].repo_private')
          echo "REPO_PRIVATE=$REPO_PRIVATE" >> $GITHUB_ENV

      - name: Checkout ${{ env.REPO_NAME }} repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.GIT_REPO }}/${{ env.REPO_NAME }}
          ref: main
          path: ${{ env.REPO_NAME }}
          ssh-key: ${{ env.REPO_PRIVATE == 'true' && secrets.SSH_PRIVATE_KEY || '' }}

      - name: Setup node-${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Process components with ${{ env.REPO_NAME }} - ${{ env.COMPONENTS}}
        working-directory: ${{ env.REPO_NAME }}
        run: |
          CONFIG=$(cat "$GITHUB_WORKSPACE/$CONFIG_FILE")
          
          for CPT in $COMPONENTS; do
            echo "--------------------------------------------------"
            echo "Processing: $CPT ($REPO_NAME)"
            echo "--------------------------------------------------"
            
            # --- 1. Config Inheritance ---
            # Priority: Component Config > Repo Config
            REPO_ROOT=".[ \"$REPO_NAME\" ]"
            COMP_ROOT="$REPO_ROOT.components[ \"$CPT\" ]"
            
            get_config() {
                echo "$CONFIG" | jq -r "$COMP_ROOT.$1 // $REPO_ROOT.$1 // empty"
            }
            
            WORK_DIR=$(get_config "work_dir")
            DIST_DIR=$(get_config "dist_dir")
            BUILD_CMD=$(get_config "build_cmd")
            PUBLISH_CMD=$(get_config "publish_cmd")
            VERSION_FILE=$(get_config "version_file")
            ADAPTER=$(get_config "adapter_script")
            
            # --- 2. Get Version ---
            SAFE_NAME=$(echo "$CPT" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            INPUT_KEY="${SAFE_NAME}_VERSION"
            VERSION=$(echo "$INPUTS_JSON" | jq -r --arg k "$INPUT_KEY" '.[$k]')
            
            echo "  Target: $VERSION | Dir: $WORK_DIR"
            echo "::notice title=Config::Component: $CPT | Version: $VERSION | Repo: $REPO_NAME"
            
            # --- 3. Set Version ---
            pushd "$WORK_DIR" > /dev/null
            if [[ "$VERSION_FILE" == "tsup.config.ts" ]]; then
               sed -i "s/version:\s*\"[^\"]*\"/version: \"$VERSION\"/" "$VERSION_FILE"
            else
               tmp=$(mktemp)
               jq --arg v "$VERSION" '.version = $v' package.json > "$tmp" && mv "$tmp" package.json
            fi
            popd > /dev/null

            # --- 4. Adapter ---
            if [[ "$ADAPTER" == "true" ]]; then
               TARGET="src/utils/platformAdapter.ts"
               [ -f "$TARGET" ] && sed -i 's|^\s*//\(\s*.*Web.*\)| \1|g; s|^\s*\([^/].*Tauri.*\)|//\1|g' "$TARGET" || true
            fi

            # --- 5. Install Dependencies ---
            pushd "$WORK_DIR" > /dev/null
            echo "  Installing dependencies..."
            pnpm install
            popd > /dev/null

            # --- 6. Build ---
            pushd "$WORK_DIR" > /dev/null
            echo "  Building..."
            eval "$BUILD_CMD"
            popd > /dev/null

            # --- 7. Publish ---
            pushd "$DIST_DIR" > /dev/null
            echo "  Publishing..."
            tmp=$(mktemp)
            jq --arg url "$REPO_URL" '.repository = { type: "git", url: $url }' package.json > "$tmp" && mv "$tmp" package.json
            eval "$PUBLISH_CMD"
            popd > /dev/null
            
            # --- 8. Save Metadata ---
            mkdir -p "$GITHUB_WORKSPACE/release_info"
            echo "${REPO_NAME}|${CPT}|${INPUT_KEY}|${VERSION}" > "$GITHUB_WORKSPACE/release_info/${CPT}.txt"
          done

      - name: Upload release info for ${{ env.REPO_NAME }} - ${{ env.COMPONENTS}}
        uses: actions/upload-artifact@v4
        with:
          name: release-info-${{ env.REPO_NAME }}-${{ github.run_id }}
          path: release_info/*.txt
          retention-days: 1

  update-workflow:
    needs: publish
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@v4

      - name: Download all release infos
        uses: actions/download-artifact@v4
        with:
          path: all_releases
          pattern: release-info-*
          merge-multiple: true

      - name: Update configuration and workflow
        id: update
        run: |
          WORKFLOW_PATH="$GITHUB_WORKSPACE/$WORKFLOW_FILE"
          CONFIG_PATH="$GITHUB_WORKSPACE/$CONFIG_FILE"
          UPDATES_COUNT=0
          TITLE_LIST=""

          for f in all_releases/*.txt; do
            if [[ -f "$f" ]]; then
              line=$(cat "$f")
              # Format: REPO|COMP|KEY|VER
              REPO=$(echo "$line" | cut -d'|' -f1)
              COMP=$(echo "$line" | cut -d'|' -f2)
              KEY=$(echo "$line" | cut -d'|' -f3)
              VER=$(echo "$line" | cut -d'|' -f4)
              
              echo "Updating: $COMP -> $VER"
              ITEM="${COMP}@${VER}"
              if [[ -z "$TITLE_LIST" ]]; then TITLE_LIST="$ITEM"; else TITLE_LIST="$TITLE_LIST, $ITEM"; fi

              # 1. Update YAML (Handle One-line Object Syntax)
              # Matches:   SEARCH_CHAT_VERSION: { ... default: "1.3.8" }
              if grep -q "$KEY:" "$WORKFLOW_PATH"; then
                 sed -i "/^ *$KEY:/ s/default: \"[^\"]*\"/default: \"$VER\"/" "$WORKFLOW_PATH"
              fi
              
              # 2. Update JSON (Nested Structure)
              tmp=$(mktemp)
              jq --arg r "$REPO" --arg c "$COMP" --arg v "$VER" \
                 '.[$r].components[$c].current_version = $v' "$CONFIG_PATH" > "$tmp" && mv "$tmp" "$CONFIG_PATH"
              
              UPDATES_COUNT=$((UPDATES_COUNT+1))
            fi
          done
          
          if [[ $UPDATES_COUNT -gt 0 ]]; then
             echo "has_updates=true" >> $GITHUB_OUTPUT
             echo "title_info=$TITLE_LIST" >> $GITHUB_OUTPUT
          else
             echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create bumpver pull request
        if: ${{ steps.update.outputs.has_updates == 'true' }}
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.REPO_PAT }}
          commit-message: "bumpver: publish ${{ steps.update.outputs.title_info }} to npm"
          branch: "release/publish-npm-${{ github.run_id }}"
          title: "bumpver: publish ${{ steps.update.outputs.title_info }} to npm"
          body: "Automated publish to npm: ${{ steps.update.outputs.title_info }}"
          labels: "auto-merge, automated"
          delete-branch: true
          add-paths: |
            ${{ env.WORKFLOW_FILE }}
            ${{ env.CONFIG_FILE }}

      - name: Auto-merge the pr
        if: ${{ steps.create-pr.outputs.pull-request-url }}
        env:
          PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: gh pr merge "$PR_URL" --auto --merge

  notify_on_failure:
    runs-on: ubuntu-latest
    if: failure()
    needs: [publish,update-workflow]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Notify message via feishu
        env:
          FEISHU_BOT_URL: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.triggering_actor }}
          STATUS: ${{ needs.update-workflow.result == 'skipped' && needs.publish.result || needs.update-workflow.result }}
        run: $GITHUB_WORKSPACE/scripts/feishu_message.sh
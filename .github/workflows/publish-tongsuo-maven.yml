name: Publish Tongsuo Java SDK to Maven Central

defaults:
  run:
    shell: bash

env:
  TZ: Asia/Shanghai
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_CONFIG: ${{ secrets.SSH_CONFIG }}

on:
  workflow_dispatch:
    inputs:
      PUBLISH_VERSION:
        description: 'Version to publish (e.g., 1.1.0)'
        required: true
        type: string
        default: '1.1.0'
      BRANCH:
        description: 'tongsuo-java-sdk branch to build from'
        required: true
        type: string
        default: 'master'
      TONGSUO_VERSION:
        description: 'Tongsuo version (branch/tag)'
        required: true
        type: string
        default: 'master'
      
      # API Version
      API_VERSION:
        description: 'API compatibility version'
        required: true
        type: choice
        options:
          - 'default'
          - '1.1.1'
          - '1.0.2'
        default: 'default'
      
      # Feature Flags
      ENABLE_NTLS:
        description: 'Enable NTLS (å›½å¯†)'
        required: false
        type: boolean
        default: true
      
      ENABLE_SM2:
        description: 'Enable SM2'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM3:
        description: 'Enable SM3'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM4:
        description: 'Enable SM4'
        required: false
        type: boolean
        default: false
      
      ENABLE_DEBUG:
        description: 'Enable debug symbols'
        required: false
        type: boolean
        default: false
      
      # Advanced Options
      EXTRA_CONFIG_OPTS:
        description: 'Extra options (optional)'
        required: false
        type: string
        default: ''
      
      # Build Environment
      USE_DOCKER_BUILD:
        description: 'Use Docker for Linux'
        required: true
        type: boolean
        default: true
      
      LINUX_DOCKER_IMAGE:
        description: 'Docker image (GLIBC)'
        required: true
        type: choice
        options:
          - 'ubuntu:18.04'
          - 'ubuntu:20.04'
          - 'ubuntu:22.04'
          - 'ubuntu:24.04'
        default: 'ubuntu:18.04'

jobs:
  build-all-platforms:
    name: Build ${{ matrix.platform_name }}
    runs-on: ${{ matrix.use_docker && 'ubuntu-latest' || matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_name: linux-x86_64
            os: ubuntu-22.04
            arch: linux-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo -static -Wl,--no-as-needed -ldl"
            cc_prefix: ""
            use_docker: true
            
          - platform_name: linux-aarch_64
            os: ubuntu-22.04
            arch: linux-aarch_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo --cross-compile-prefix=aarch64-linux-gnu- linux-aarch64 -static -Wl,--no-as-needed -ldl"
            cc_prefix: ""
            use_docker: true
            
          - platform_name: osx-x86_64
            os: macos-14
            arch: darwin64-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-x86_64"
            cc_prefix: ""
            cross_compile: true
            
          - platform_name: osx-aarch_64
            os: macos-14
            arch: darwin64-arm64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-arm64"
            cc_prefix: ""
            cross_compile: false
            
          - platform_name: windows-x86_64
            os: windows-2022
            arch: VC-WIN64A
            tongsuo_base_config: "--prefix=$HOME/tongsuo VC-WIN64A"
            cc_prefix: ""

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Install build dependencies (Linux - Native)
        if: runner.os == 'Linux' && !inputs.USE_DOCKER_BUILD
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl patchelf
          if [[ "${{ matrix.arch }}" == "linux-aarch_64" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user-static
          fi

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install perl

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install Strawberry Perl and NASM
          choco install strawberryperl -y
          choco install nasm -y
          
          # Add Strawberry Perl to PATH for this and subsequent steps
          echo "C:\Strawberry\perl\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Strawberry\c\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          # Also update PATH for current step
          $env:Path = "C:\Strawberry\perl\bin;C:\Strawberry\c\bin;" + $env:Path
          
          # Show perl version
          Write-Host "Perl version:"
          perl -v
          
          # Show perl installation path
          Write-Host "`nPerl location:"
          where.exe perl
          
          # Install required Perl modules
          Write-Host "`nInstalling Locale::Maketext::Simple..."
          cpan -T Locale::Maketext::Simple
          
          Write-Host "`nVerifying installation..."
          perl -MLocale::Maketext::Simple -e "print qq{âœ… Module installed successfully\n}"

      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup Environment Variables
        shell: bash
        run: |
          # Set TONGSUO_HOME
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "TONGSUO_HOME=$HOME/tongsuo" >> $GITHUB_ENV
          else
            echo "TONGSUO_HOME=$HOME/tongsuo" >> $GITHUB_ENV
          fi
          
          # Set architecture-specific flags for macOS x86_64 cross-compilation
          if [[ "${{ runner.os }}" == "macOS" && "${{ matrix.arch }}" == "darwin64-x86_64" ]]; then
            echo "CC=clang -arch x86_64" >> $GITHUB_ENV
            echo "CXX=clang++ -arch x86_64" >> $GITHUB_ENV
            echo "CFLAGS=-arch x86_64" >> $GITHUB_ENV
            echo "CXXFLAGS=-arch x86_64" >> $GITHUB_ENV
            echo "LDFLAGS=-arch x86_64" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_arch=x86_64" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_ldFlags=-arch x86_64" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_cFlags=-arch x86_64" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_cppFlags=-arch x86_64" >> $GITHUB_ENV
            echo "âœ… Configured cross-compilation for x86_64"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "âœ… Building natively for ARM64"
          fi

      - name: Checkout tongsuo-java-sdk
        uses: actions/checkout@v6
        with:
          repository: 'infinilabs/tongsuo-java-sdk'
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ref: ${{ inputs.BRANCH }}
          path: tongsuo-java-sdk

      - name: Build with Docker (Linux)
        if: runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker
        run: |
          set -e
          
          # Create build script that will run inside Docker
          cat > docker-build.sh << 'DOCKER_BUILD_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Docker Build Environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat /etc/os-release | grep PRETTY_NAME
          
          GLIBC_VERSION=$(ldd --version 2>&1 | awk 'NR==1 {print $NF}')
          echo "GLIBC Version: $GLIBC_VERSION"
          echo "Architecture: $(uname -m)"
          echo ""
          echo "âš ï¸  Binaries will require GLIBC $GLIBC_VERSION or higher"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Install dependencies
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y build-essential perl patchelf git wget curl openjdk-11-jdk-headless
          
          ARCH_PARAM="${{ matrix.arch }}"
          if [[ "$ARCH_PARAM" == "linux-aarch_64" ]]; then
            apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user-static
          fi
          
          # Build Tongsuo
          cd /build
          echo "Building Tongsuo ${{ inputs.TONGSUO_VERSION }}..."
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          # Configure based on inputs - replace $HOME with /root for Docker
          CONFIG_OPTS="${{ matrix.tongsuo_base_config }}"
          CONFIG_OPTS="${CONFIG_OPTS//\$HOME\/tongsuo/\/root\/tongsuo}"
          CONFIG_OPTS="${CONFIG_OPTS//\$\{HOME\}\/tongsuo/\/root\/tongsuo}"
          
          if [[ "${{ inputs.API_VERSION }}" != "default" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --api=${{ inputs.API_VERSION }}"
          fi
          
          if [[ "${{ inputs.ENABLE_NTLS }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-ntls"
          else
            CONFIG_OPTS="$CONFIG_OPTS no-ntls"
          fi
          
          if [[ "${{ inputs.ENABLE_SM2 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm2"
          fi
          
          if [[ "${{ inputs.ENABLE_SM3 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm3"
          fi
          
          if [[ "${{ inputs.ENABLE_SM4 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm4"
          fi
          
          if [[ "${{ inputs.ENABLE_DEBUG }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --debug"
          fi
          
          if [[ -n "${{ inputs.EXTRA_CONFIG_OPTS }}" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS ${{ inputs.EXTRA_CONFIG_OPTS }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tongsuo Configuration:"
          echo "  ./config $CONFIG_OPTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ./config $CONFIG_OPTS
          make -j$(nproc)
          make install_sw
          
          # Create symlink if lib64 exists but lib doesn't
          if [ -d /root/tongsuo/lib64 ] && [ ! -d /root/tongsuo/lib ]; then
            echo "Creating symlink: lib -> lib64"
            ln -s lib64 /root/tongsuo/lib
          fi
          
          echo ""
          echo "âœ… Tongsuo built successfully"
          echo "Installation directory contents:"
          ls -lh /root/tongsuo/
          if [ -d /root/tongsuo/lib ]; then
            echo "Libraries:"
            ls -lh /root/tongsuo/lib/
          elif [ -d /root/tongsuo/lib64 ]; then
            echo "Libraries (lib64):"
            ls -lh /root/tongsuo/lib64/
          else
            echo "âš ï¸  Warning: lib directory not found, checking installation:"
            find /root/tongsuo -name "*.a" -o -name "*.so*"
          fi
          
          # Build Java SDK
          cd /build/tongsuo-java-sdk
          
          # Copy the init script for publishing
          cp -f /build/products/tongsuo/build.gradle init-publish.gradle
          
          export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
          ./gradlew --init-script init-publish.gradle \
                    -Pversion=${{ inputs.PUBLISH_VERSION }} \
                    -PtongsuoHome=/root/tongsuo \
                    -PcheckErrorQueue \
                    :tongsuo-openjdk:publishToMavenLocal
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Build Completed Successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Maven Artifacts:"
          find /root/.m2/repository/com/infinilabs/tongsuo-openjdk -type f | head -20
          echo ""
          echo "ğŸ“‹ Build Information:"
          echo "  Platform: ${{ matrix.platform_name }}"
          echo "  GLIBC Version: $GLIBC_VERSION"
          echo "  Tongsuo Version: ${{ inputs.TONGSUO_VERSION }}"
          echo "  Publish Version: ${{ inputs.PUBLISH_VERSION }}"
          echo ""
          echo "âš ï¸  IMPORTANT: This binary requires GLIBC $GLIBC_VERSION or higher"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          DOCKER_BUILD_SCRIPT
          
          chmod +x docker-build.sh
          
          # Run build in Docker
          docker run --rm \
            -v $GITHUB_WORKSPACE:/build \
            -v $HOME/.m2:/root/.m2 \
            -w /build \
            ${{ inputs.LINUX_DOCKER_IMAGE }} \
            /build/docker-build.sh

      - name: Show build environment info (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) }}
        shell: bash
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Build Environment Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "Distribution: $(lsb_release -d | cut -f2-)"
            echo "GLIBC Version: $(ldd --version 2>&1 | awk 'NR==1 {print $NF}')"
            echo ""
            echo "âš ï¸  Binaries built on this system require GLIBC $(ldd --version 2>&1 | awk 'NR==1 {print $NF}') or higher"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build Tongsuo (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) && runner.os != 'Windows' }}
        shell: bash
        run: |
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Building Tongsuo"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Version:     ${{ inputs.TONGSUO_VERSION }}"
          echo "Platform:    ${{ matrix.platform_name }}"
          echo "API Version: ${{ inputs.API_VERSION }}"
          echo "Features:"
          echo "  â€¢ NTLS:    ${{ inputs.ENABLE_NTLS }}"
          echo "  â€¢ SM2:     ${{ inputs.ENABLE_SM2 }}"
          echo "  â€¢ SM3:     ${{ inputs.ENABLE_SM3 }}"
          echo "  â€¢ SM4:     ${{ inputs.ENABLE_SM4 }}"
          echo "  â€¢ Debug:   ${{ inputs.ENABLE_DEBUG }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          # cc_prefix is used for Linux cross-compilation
          if [[ -n "${{ matrix.cc_prefix }}" ]]; then
            export CC=${{ matrix.cc_prefix }}gcc
            export CXX=${{ matrix.cc_prefix }}g++
          fi
          
          # Build configuration from inputs
          CONFIG_OPTS="${{ matrix.tongsuo_base_config }}"
          
          # API Version (skip if 'default')
          if [[ "${{ inputs.API_VERSION }}" != "default" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --api=${{ inputs.API_VERSION }}"
          fi
          
          # Feature flags
          if [[ "${{ inputs.ENABLE_NTLS }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-ntls"
          else
            CONFIG_OPTS="$CONFIG_OPTS no-ntls"
          fi
          
          if [[ "${{ inputs.ENABLE_SM2 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm2"
          fi
          
          if [[ "${{ inputs.ENABLE_SM3 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm3"
          fi
          
          if [[ "${{ inputs.ENABLE_SM4 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm4"
          fi
          
          if [[ "${{ inputs.ENABLE_DEBUG }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --debug"
          fi
          
          # Extra options
          if [[ -n "${{ inputs.EXTRA_CONFIG_OPTS }}" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS ${{ inputs.EXTRA_CONFIG_OPTS }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Full config command:"
          echo "  ./config $CONFIG_OPTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ./config $CONFIG_OPTS
          
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
          make install_sw
          
          # Create symlink if lib64 exists but lib doesn't (Linux)
          if [ -d "$TONGSUO_HOME/lib64" ] && [ ! -d "$TONGSUO_HOME/lib" ]; then
            echo "Creating symlink: lib -> lib64"
            cd "$TONGSUO_HOME" && ln -s lib64 lib
          fi
          
          echo "TONGSUO_HOME=$HOME/tongsuo" >> $GITHUB_ENV
          
          # Show Tongsuo version and features
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tongsuo build completed:"
          $HOME/tongsuo/bin/openssl version
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build Tongsuo (Native - Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Building Tongsuo for Windows"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Version:     ${{ inputs.TONGSUO_VERSION }}"
          Write-Host "Platform:    ${{ matrix.platform_name }}"
          Write-Host "API Version: ${{ inputs.API_VERSION }}"
          Write-Host "Features:"
          Write-Host "  â€¢ NTLS:    ${{ inputs.ENABLE_NTLS }}"
          Write-Host "  â€¢ SM2:     ${{ inputs.ENABLE_SM2 }}"
          Write-Host "  â€¢ SM3:     ${{ inputs.ENABLE_SM3 }}"
          Write-Host "  â€¢ SM4:     ${{ inputs.ENABLE_SM4 }}"
          Write-Host "  â€¢ Debug:   ${{ inputs.ENABLE_DEBUG }}"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          # Build configuration
          $CONFIG_OPTS = "${{ matrix.tongsuo_base_config }}"
          
          # API Version
          if ("${{ inputs.API_VERSION }}" -ne "default") {
            $CONFIG_OPTS += " --api=${{ inputs.API_VERSION }}"
          }
          
          # Feature flags
          if ("${{ inputs.ENABLE_NTLS }}" -eq "true") {
            $CONFIG_OPTS += " enable-ntls"
          } else {
            $CONFIG_OPTS += " no-ntls"
          }
          
          if ("${{ inputs.ENABLE_SM2 }}" -eq "true") {
            $CONFIG_OPTS += " enable-sm2"
          }
          
          if ("${{ inputs.ENABLE_SM3 }}" -eq "true") {
            $CONFIG_OPTS += " enable-sm3"
          }
          
          if ("${{ inputs.ENABLE_SM4 }}" -eq "true") {
            $CONFIG_OPTS += " enable-sm4"
          }
          
          if ("${{ inputs.ENABLE_DEBUG }}" -eq "true") {
            $CONFIG_OPTS += " --debug"
          }
          
          # Extra options
          if ("${{ inputs.EXTRA_CONFIG_OPTS }}") {
            $CONFIG_OPTS += " ${{ inputs.EXTRA_CONFIG_OPTS }}"
          }
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Full config command:"
          Write-Host "  perl Configure $CONFIG_OPTS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Use perl Configure instead of ./config on Windows
          perl Configure ($CONFIG_OPTS -split ' ')
          nmake
          nmake install_sw
          
          # Set environment variable for next steps
          $env:TONGSUO_HOME = "$env:HOME\tongsuo"
          "TONGSUO_HOME=$env:HOME\tongsuo" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Tongsuo build completed:"
          & "$env:HOME\tongsuo\bin\openssl.exe" version
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build and publish JAR with custom groupId (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) }}
        shell: bash
        working-directory: tongsuo-java-sdk
        run: |
          set -e
          
          # Use init script instead of replacing build.gradle
          cp -f $GITHUB_WORKSPACE/products/tongsuo/build.gradle init-publish.gradle
          
          # For macOS x86_64, use Rosetta 2 to run Gradle
          GRADLE_CMD="./gradlew"
          if [[ "${{ runner.os }}" == "macOS" && "${{ matrix.arch }}" == "darwin64-x86_64" ]]; then
            GRADLE_CMD="arch -x86_64 ./gradlew"
          fi
          
          # Build and publish to Maven local repository
          $GRADLE_CMD --init-script init-publish.gradle \
                      -Pversion=${{ inputs.PUBLISH_VERSION }} \
                      -PtongsuoHome="$TONGSUO_HOME" \
                      -PcheckErrorQueue \
                      :tongsuo-openjdk:publishToMavenLocal
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Published to Maven local repository"
          find ~/.m2/repository/com/infinilabs/tongsuo-openjdk -type f | head -20

      - name: Upload Maven repository
        uses: actions/upload-artifact@v4
        with:
          name: maven-repo-${{ matrix.platform_name }}
          path: ~/.m2/repository/com/infinilabs/tongsuo-openjdk/${{ inputs.PUBLISH_VERSION }}/**/*
          retention-days: 7

      - name: Build Summary
        shell: bash
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Platform Build Complete: ${{ matrix.platform_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # System Information
          echo ""
          echo "ğŸ“‹ Build Environment:"
          echo "  OS:           ${{ runner.os }}"
          echo "  Architecture: $(uname -m)"
          
          # OS Distribution (Linux/macOS)
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            if [ -f /etc/os-release ]; then
              DISTRO=$(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)
              echo "  Distribution: $DISTRO"
            fi
          elif [[ "${{ runner.os }}" == "Darwin" ]]; then
            MACOS_VERSION=$(sw_vers -productVersion)
            echo "  macOS Version: $MACOS_VERSION"
          fi
          
          # Compiler Information
          echo ""
          echo "ğŸ”§ Toolchain:"
          if command -v gcc >/dev/null 2>&1; then
            GCC_VERSION=$(gcc --version 2>&1 | head -1)
            echo "  GCC:  $GCC_VERSION"
          fi
          if command -v clang >/dev/null 2>&1; then
            CLANG_VERSION=$(clang --version 2>&1 | head -1)
            echo "  Clang: $CLANG_VERSION"
          fi
          if [[ "${{ runner.os }}" == "Windows" ]] && command -v cl >/dev/null 2>&1; then
            CL_VERSION=$(cl 2>&1 | head -1)
            echo "  MSVC: $CL_VERSION"
          fi
          
          # Java Information
          echo ""
          echo "â˜• Java:"
          JAVA_VERSION=$(java -version 2>&1 | head -1)
          echo "  $JAVA_VERSION"
          
          # GLIBC Information (Linux only)
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo ""
            echo "ğŸ“¦ GLIBC:"
            if [[ "${{ inputs.USE_DOCKER_BUILD }}" == "true" && "${{ matrix.use_docker }}" == "true" ]]; then
              # Extract GLIBC version from Docker image name
              IMAGE="${{ inputs.LINUX_DOCKER_IMAGE }}"
              case "$IMAGE" in
                "ubuntu:18.04") GLIBC="2.27" ;;
                "ubuntu:20.04") GLIBC="2.31" ;;
                "ubuntu:22.04") GLIBC="2.35" ;;
                "ubuntu:24.04") GLIBC="2.39" ;;
                *) GLIBC="unknown" ;;
              esac
              echo "  Build Image:  $IMAGE"
              echo "  GLIBC Version: $GLIBC"
              echo "  âš ï¸  Binaries require GLIBC $GLIBC or higher"
            else
              GLIBC=$(ldd --version 2>&1 | awk 'NR==1 {print $NF}')
              echo "  GLIBC Version: $GLIBC"
              echo "  âš ï¸  Binaries require GLIBC $GLIBC or higher"
            fi
          fi
          
          # Tongsuo Information
          echo ""
          echo "ğŸ” Tongsuo:"
          if [ -f "$HOME/tongsuo/bin/openssl" ]; then
            TONGSUO_VER=$($HOME/tongsuo/bin/openssl version)
            echo "  Version: $TONGSUO_VER"
          elif [ -f "/root/tongsuo/bin/openssl" ]; then
            TONGSUO_VER=$(/root/tongsuo/bin/openssl version)
            echo "  Version: $TONGSUO_VER"
          fi
          echo "  API:     ${{ inputs.API_VERSION }}"
          echo "  NTLS:    ${{ inputs.ENABLE_NTLS }}"
          echo "  SM2/3/4: ${{ inputs.ENABLE_SM2 }}/${{ inputs.ENABLE_SM3 }}/${{ inputs.ENABLE_SM4 }}"
          
          # Build Method
          echo ""
          echo "ğŸ”¨ Build:"
          if [[ "${{ runner.os }}" == "Linux" && "${{ inputs.USE_DOCKER_BUILD }}" == "true" && "${{ matrix.use_docker }}" == "true" ]]; then
            echo "  Method: Docker"
          else
            echo "  Method: Native"
          fi
          echo "  Version: ${{ inputs.PUBLISH_VERSION }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  publish:
    name: Create Maven Central Bundle
    needs: build-all-platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v6

      - name: Setup bootstrap
        uses: ./containers/bootstrap

      - name: Run connect in background
        run: |
          connect -c "$GITHUB_WORKSPACE/.net.json" >/dev/null 2>&1 &
          echo "Connect started with pid $!"
          sleep 5

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Download all Maven repositories
        uses: actions/download-artifact@v4
        with:
          path: maven-repos
          pattern: maven-repo-*
          merge-multiple: false

      - name: Merge Maven repositories
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          MERGED_REPO="$GITHUB_WORKSPACE/merged-repo"
          mkdir -p "$MERGED_REPO/$GROUP_PATH/$ARTIFACT_ID/$VERSION"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Merging Maven repositories from all platforms"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Copy all platform Maven repositories
          for repo_dir in maven-repos/maven-repo-*; do
            if [ -d "$repo_dir" ]; then
              platform=$(basename "$repo_dir" | sed 's/maven-repo-//')
              echo "ğŸ“¦ Merging platform: $platform"
              
              # Copy all files from this platform's repo
              if [ -d "$repo_dir" ]; then
                cp -rv "$repo_dir"/* "$MERGED_REPO/$GROUP_PATH/$ARTIFACT_ID/$VERSION/" || true
              fi
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Merged repository contents:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          find "$MERGED_REPO" -type f | head -50

      - name: Verify Maven Central requirements
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          REPO_PATH="$GITHUB_WORKSPACE/merged-repo/$GROUP_PATH/$ARTIFACT_ID/$VERSION"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verifying Maven Central bundle requirements"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Count required files
          JAR_COUNT=$(find "$REPO_PATH" -name "*.jar" ! -name "*javadoc*" ! -name "*sources*" | wc -l)
          POM_COUNT=$(find "$REPO_PATH" -name "*.pom" | wc -l)
          SOURCES_COUNT=$(find "$REPO_PATH" -name "*-sources.jar" | wc -l)
          JAVADOC_COUNT=$(find "$REPO_PATH" -name "*-javadoc.jar" | wc -l)
          ASC_COUNT=$(find "$REPO_PATH" -name "*.asc" | wc -l)
          
          echo "Main JARs:    $JAR_COUNT"
          echo "POM files:    $POM_COUNT"
          echo "Sources JARs: $SOURCES_COUNT"
          echo "Javadoc JARs: $JAVADOC_COUNT"
          echo "Signatures:   $ASC_COUNT"
          
          if [ "$POM_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No POM files found!"
            exit 1
          fi
          
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No JAR files found!"
            exit 1
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Bundle validation passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create Maven Central bundle ZIP
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          cd "$GITHUB_WORKSPACE/merged-repo"
          
          # Create the ZIP bundle (Maven Central expects a specific structure)
          ZIP_NAME="tongsuo-openjdk-${VERSION}.zip"
          zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" "$GROUP_PATH"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Maven Central bundle created:"
          echo "   File: $ZIP_NAME"
          echo "   Size: $(du -h "$GITHUB_WORKSPACE/$ZIP_NAME" | cut -f1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload to Maven Central Portal
        run: |
          ZIP_FILE="$GITHUB_WORKSPACE/tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}.zip"
          
          if [ ! -f "$ZIP_FILE" ]; then
            echo "âŒ ERROR: ZIP file not found: $ZIP_FILE"
            exit 1
          fi
          
          echo "ğŸ“¤ Uploading bundle to Maven Central Portal"
          export ZIP_FILE_PATH="$ZIP_FILE"
          python3 $GITHUB_WORKSPACE/scripts/publish_central.py
        env:
          DEBUG: true
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: maven-central-bundle
          path: tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}.zip
          retention-days: 30

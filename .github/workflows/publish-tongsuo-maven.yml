name: Publish Tongsuo Java SDK to Maven Central

defaults:
  run:
    shell: bash

env:
  TZ: Asia/Shanghai
  SSH_GIT_REPO: ${{ secrets.SSH_GIT_REPO }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_CONFIG: ${{ secrets.SSH_CONFIG }}

on:
  workflow_dispatch:
    inputs:
      PUBLISH_VERSION:
        description: 'Version to publish (e.g., 1.1.0)'
        required: true
        type: string
        default: '1.1.0'
      BRANCH:
        description: 'tongsuo-java-sdk branch to build from'
        required: true
        type: string
        default: 'master'
      TONGSUO_VERSION:
        description: 'Tongsuo branch/tag to build (e.g., master, 8.4-stable, 8.3.3)'
        required: true
        type: string
        default: 'master'
      
      # API Version
      API_VERSION:
        description: 'API compatibility version'
        required: true
        type: choice
        options:
          - '3.0'
          - '1.1.1'
          - '1.0.2'
        default: '3.0'
      
      # Feature Flags
      ENABLE_NTLS:
        description: 'Enable NTLS (国密)'
        required: false
        type: boolean
        default: true
      
      ENABLE_SM2:
        description: 'Enable SM2'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM3:
        description: 'Enable SM3'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM4:
        description: 'Enable SM4'
        required: false
        type: boolean
        default: false
      
      ENABLE_DEBUG:
        description: 'Enable debug symbols'
        required: false
        type: boolean
        default: false
      
      # Advanced Options
      EXTRA_CONFIG_OPTS:
        description: 'Extra options (optional)'
        required: false
        type: string
        default: ''

jobs:
  build-all-platforms:
    name: Build ${{ matrix.platform_name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_name: linux-x86_64
            os: ubuntu-22.04
            arch: linux-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo -static -Wl,--no-as-needed -ldl"
            cc_prefix: ""
            
          - platform_name: linux-aarch_64
            os: ubuntu-22.04
            arch: linux-aarch_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo --cross-compile-prefix=aarch64-linux-gnu- linux-aarch64 -static -Wl,--no-as-needed -ldl"
            cc_prefix: "aarch64-linux-gnu-"
            
          - platform_name: osx-x86_64
            os: macos-14
            arch: darwin64-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-x86_64"
            cc_prefix: ""
            cross_compile: true
            
          - platform_name: osx-aarch_64
            os: macos-14
            arch: darwin64-arm64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-arm64"
            cc_prefix: ""
            cross_compile: false
            
          - platform_name: windows-x86_64
            os: windows-2022
            arch: VC-WIN64A
            tongsuo_base_config: "--prefix=$HOME/tongsuo VC-WIN64A"
            cc_prefix: ""

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl patchelf
          if [[ "${{ matrix.arch }}" == "linux-aarch_64" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user-static
          fi

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install perl

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install strawberryperl -y
          choco install nasm -y

      - name: Checkout tongsuo-java-sdk
        run: |
          git clone --depth 1 --branch ${{ inputs.BRANCH }} $SSH_GIT_REPO/tongsuo-java-sdk $GITHUB_WORKSPACE/tongsuo-java-sdk

      - name: Build Tongsuo
        shell: bash
        run: |
          set -e
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Building Tongsuo"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Version: ${{ inputs.TONGSUO_VERSION }}"
          echo "  Platform: ${{ matrix.platform_name }}"
          echo "  API Version: ${{ inputs.API_VERSION }}"
          echo "  Features:"
          echo "    - NTLS: ${{ inputs.ENABLE_NTLS }}"
          echo "    - SM2: ${{ inputs.ENABLE_SM2 }}"
          echo "    - SM3: ${{ inputs.ENABLE_SM3 }}"
          echo "    - SM4: ${{ inputs.ENABLE_SM4 }}"
          echo "    - Debug: ${{ inputs.ENABLE_DEBUG }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          if [[ -n "${{ matrix.cc_prefix }}" ]]; then
            export CC=${{ matrix.cc_prefix }}gcc
            export CXX=${{ matrix.cc_prefix }}g++
          fi
          
          # Build configuration from inputs
          CONFIG_OPTS="${{ matrix.tongsuo_base_config }}"
          
          # API Version
          if [[ "${{ inputs.API_VERSION }}" != "3.0" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --api=${{ inputs.API_VERSION }}"
          fi
          
          # Feature flags
          if [[ "${{ inputs.ENABLE_NTLS }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-ntls"
          else
            CONFIG_OPTS="$CONFIG_OPTS no-ntls"
          fi
          
          if [[ "${{ inputs.ENABLE_SM2 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm2"
          fi
          
          if [[ "${{ inputs.ENABLE_SM3 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm3"
          fi
          
          if [[ "${{ inputs.ENABLE_SM4 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm4"
          fi
          
          if [[ "${{ inputs.ENABLE_DEBUG }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --debug"
          fi
          
          # Extra options
          if [[ -n "${{ inputs.EXTRA_CONFIG_OPTS }}" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS ${{ inputs.EXTRA_CONFIG_OPTS }}"
          fi
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Full config command:"
          echo "  ./config $CONFIG_OPTS"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          ./config $CONFIG_OPTS
          
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
          make install_sw
          
          echo "TONGSUO_HOME=$HOME/tongsuo" >> $GITHUB_ENV
          
          # Show Tongsuo version and features
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Tongsuo build completed:"
          $HOME/tongsuo/bin/openssl version
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Build JAR with custom groupId
        shell: bash
        working-directory: tongsuo-java-sdk
        run: |
          set -e
          
          # Use custom groupId and version
          ./gradlew -PmavenGroupId=com.infinilabs \
                    -Pversion=${{ inputs.PUBLISH_VERSION }} \
                    -PcheckErrorQueue \
                    :tongsuo-openjdk:build

      - name: Prepare artifacts
        shell: bash
        run: |
          set -e
          mkdir -p artifacts/${{ matrix.platform_name }}
          
          # Find built JARs
          MAIN_JAR=$(find tongsuo-java-sdk/openjdk/build/libs -name "tongsuo-openjdk-*.jar" ! -name "*-javadoc.jar" ! -name "*-sources.jar" | head -1)
          SOURCES_JAR=$(find tongsuo-java-sdk/openjdk/build/libs -name "tongsuo-openjdk-*-sources.jar" | head -1)
          JAVADOC_JAR=$(find tongsuo-java-sdk/openjdk/build/libs -name "tongsuo-openjdk-*-javadoc.jar" | head -1)
          
          # Copy with platform classifier
          if [ -n "$MAIN_JAR" ]; then
            cp "$MAIN_JAR" "artifacts/${{ matrix.platform_name }}/tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}-${{ matrix.platform_name }}.jar"
          fi
          
          if [ -n "$SOURCES_JAR" ]; then
            cp "$SOURCES_JAR" "artifacts/${{ matrix.platform_name }}/tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}-${{ matrix.platform_name }}-sources.jar"
          fi
          
          if [ -n "$JAVADOC_JAR" ]; then
            cp "$JAVADOC_JAR" "artifacts/${{ matrix.platform_name }}/tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}-${{ matrix.platform_name }}-javadoc.jar"
          fi
          
          ls -lh artifacts/${{ matrix.platform_name }}/

      - name: Upload platform artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tongsuo-artifacts-${{ matrix.platform_name }}
          path: artifacts/${{ matrix.platform_name }}/*
          retention-days: 7

  build-uber-jars:
    name: Build Uber JARs
    needs: build-all-platforms
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: platform-jars
          pattern: tongsuo-artifacts-*

      - name: Build static uber JAR
        run: |
          set -e
          
          mkdir -p uber-static/extract
          cd uber-static/extract
          
          # Extract all platform main JARs (not sources/javadoc)
          for platform_dir in ../../platform-jars/tongsuo-artifacts-*; do
            for jar in "$platform_dir"/*.jar; do
              if [[ ! "$jar" =~ (sources|javadoc) ]]; then
                echo "Extracting $jar"
                jar xf "$jar"
              fi
            done
          done
          
          # Create static uber JAR
          cd ..
          jar cf "tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}-static-uber.jar" -C extract .
          
          echo "Static uber JAR created:"
          ls -lh *.jar

      - name: Build dynamic uber JAR  
        run: |
          set -e
          
          mkdir -p uber-dynamic/extract
          cd uber-dynamic/extract
          
          # Extract only Java classes (no native libs)
          for platform_dir in ../../platform-jars/tongsuo-artifacts-*; do
            for jar in "$platform_dir"/*.jar; do
              if [[ ! "$jar" =~ (sources|javadoc) ]]; then
                echo "Extracting classes from $jar"
                jar xf "$jar"
                # Remove native libraries
                rm -rf META-INF/native || true
              fi
            done
          done
          
          # Create dynamic uber JAR
          cd ..
          jar cf "tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}-dynamic-uber.jar" -C extract .
          
          echo "Dynamic uber JAR created:"
          ls -lh *.jar

      - name: Upload uber JARs
        uses: actions/upload-artifact@v4
        with:
          name: tongsuo-artifacts-uber
          path: |
            uber-static/*.jar
            uber-dynamic/*.jar
          retention-days: 7

  publish:
    name: Publish to Maven Central
    needs: [build-all-platforms, build-uber-jars]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v6

      - name: Setup bootstrap
        uses: ./containers/bootstrap

      - name: Run connect in background
        run: |
          connect -c "$GITHUB_WORKSPACE/.net.json" >/dev/null 2>&1 &
          echo "Connect started with pid $!"
          sleep 5

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          java-version: '11'
          distribution: 'temurin'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Checkout tongsuo-java-sdk
        run: |
          echo "Cloning tongsuo-java-sdk repository"
          git clone --depth 1 --branch ${{ inputs.BRANCH }} $SSH_GIT_REPO/tongsuo-java-sdk $GITHUB_WORKSPACE/tongsuo-java-sdk

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: tongsuo-artifacts-*

      - name: Prepare artifact repository structure
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          REPO_DIR="$GITHUB_WORKSPACE/local-repo/$GROUP_PATH/$ARTIFACT_ID/$VERSION"
          mkdir -p "$REPO_DIR"
          
          echo "Creating repository in: $REPO_DIR"
          
          # Copy build.gradle override
          cp -f $GITHUB_WORKSPACE/products/tongsuo/build.gradle $GITHUB_WORKSPACE/tongsuo-java-sdk/
          
          # Copy all platform artifacts
          for artifact_dir in all-artifacts/tongsuo-artifacts-*; do
            if [ -d "$artifact_dir" ]; then
              platform=$(basename "$artifact_dir" | sed 's/tongsuo-artifacts-//')
              echo "Processing platform: $platform"
              
              cp -v "$artifact_dir"/*.jar "$REPO_DIR/" || true
            fi
          done
          
          ls -lh "$REPO_DIR"

      - name: Build and publish bundle
        working-directory: tongsuo-java-sdk
        run: |
          set -e
          
          # Set version and use existing JARs
          echo "version=${{ inputs.PUBLISH_VERSION }}" > gradle.properties
          echo "mavenGroupId=com.infinilabs" >> gradle.properties
          
          # Configure publishing to use pre-built artifacts
          cat >> gradle.properties << 'EOF'
          
          # Publishing configuration
          signing.keyId=
          signing.password=
          signing.secretKeyRingFile=
          EOF
          
          # Use the override build.gradle from products/tongsuo
          cp -f $GITHUB_WORKSPACE/products/tongsuo/build.gradle ./build.gradle
          
          # Publish to local repo
          ./gradlew -Pversion=${{ inputs.PUBLISH_VERSION }} \
                    -PmavenGroupId=com.infinilabs \
                    :tongsuo-openjdk:publishToMavenLocal
          
          # Create distribution ZIP
          mkdir -p build/repo
          cp -r ~/.m2/repository/com/infinilabs/tongsuo-openjdk build/repo/
          
          cd build/repo
          zip -r "../tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}.zip" .
          cd ../..
          
          echo "Distribution ZIP created:"
          ls -lh build/*.zip
        env:
          SIGNING_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          SIGNING_PASSWORD: ${{ secrets.GPG_PASSPHRASE }}

      - name: Upload to Maven Central Portal
        run: |
          ZIP_FILE=$(find $GITHUB_WORKSPACE/tongsuo-java-sdk/build -name "*.zip" | head -n 1)
          echo "Found bundle: $(basename $ZIP_FILE)"
          
          export ZIP_FILE_PATH="$ZIP_FILE"
          python3 $GITHUB_WORKSPACE/scripts/publish_central.py
        env:
          DEBUG: true
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: maven-bundle
          path: tongsuo-java-sdk/build/*.zip
          retention-days: 30

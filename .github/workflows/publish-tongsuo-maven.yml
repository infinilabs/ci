name: Publish Tongsuo Java SDK to Maven Central

defaults:
  run:
    shell: bash

env:
  TZ: Asia/Shanghai
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_CONFIG: ${{ secrets.SSH_CONFIG }}

on:
  workflow_dispatch:
    inputs:
      PUBLISH_VERSION:
        description: 'Version to publish (e.g., 1.1.0)'
        required: true
        type: string
        default: '1.1.0'
      BRANCH:
        description: 'tongsuo-java-sdk branch to build from'
        required: true
        type: string
        default: 'master'
      TONGSUO_VERSION:
        description: 'Tongsuo version (branch/tag)'
        required: true
        type: string
        default: 'master'
      
      # API Version
      API_VERSION:
        description: 'API compatibility version'
        required: true
        type: choice
        options:
          - 'default'
          - '1.1.1'
          - '1.0.2'
        default: 'default'
      
      # Feature Flags
      ENABLE_NTLS:
        description: 'Enable NTLS (å›½å¯†)'
        required: false
        type: boolean
        default: true
      
      ENABLE_SM2:
        description: 'Enable SM2'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM3:
        description: 'Enable SM3'
        required: false
        type: boolean
        default: false
      
      ENABLE_SM4:
        description: 'Enable SM4'
        required: false
        type: boolean
        default: false
      
      ENABLE_DEBUG:
        description: 'Enable debug symbols'
        required: false
        type: boolean
        default: false
      
      # Advanced Options
      EXTRA_CONFIG_OPTS:
        description: 'Extra options (optional)'
        required: false
        type: string
        default: ''
      
      # Build Environment
      USE_DOCKER_BUILD:
        description: 'Use Docker for Linux'
        required: true
        type: boolean
        default: true
      
      LINUX_DOCKER_IMAGE:
        description: 'Docker image (GLIBC)'
        required: true
        type: choice
        options:
          - 'ubuntu:18.04'
          - 'ubuntu:20.04'
          - 'ubuntu:22.04'
          - 'ubuntu:24.04'
        default: 'ubuntu:18.04'

jobs:
  build-all-platforms:
    name: Build ${{ matrix.platform_name }}
    runs-on: ${{ matrix.use_docker && 'ubuntu-latest' || matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_name: linux-x86_64
            os: ubuntu-22.04
            arch: linux-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo -static -Wl,--no-as-needed -ldl"
            cc_prefix: ""
            use_docker: true
            
          - platform_name: linux-aarch_64
            os: ubuntu-22.04
            arch: linux-aarch_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo --cross-compile-prefix=aarch64-linux-gnu- linux-aarch64 -static -Wl,--no-as-needed -ldl"
            cc_prefix: ""
            use_docker: true
            
          - platform_name: osx-x86_64
            os: macos-14
            arch: darwin64-x86_64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-x86_64"
            cc_prefix: ""
            cross_compile: true
            
          - platform_name: osx-aarch_64
            os: macos-14
            arch: darwin64-arm64
            tongsuo_base_config: "--prefix=$HOME/tongsuo darwin64-arm64"
            cc_prefix: ""
            cross_compile: false
            
          - platform_name: windows-x86_64
            os: windows-2022
            arch: VC-WIN64A
            tongsuo_base_config: "--prefix=$HOME/tongsuo VC-WIN64A"
            cc_prefix: ""

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Install build dependencies (Linux - Native)
        if: runner.os == 'Linux' && !inputs.USE_DOCKER_BUILD
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl patchelf
          if [[ "${{ matrix.arch }}" == "linux-aarch_64" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user-static
          fi

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install perl

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install strawberryperl -y
          choco install nasm -y
          
          # Refresh environment to get perl in PATH
          refreshenv
          
          # Install required Perl modules
          cpan -T Locale::Maketext::Simple

      - name: Checkout tongsuo-java-sdk
        uses: actions/checkout@v6
        with:
          repository: 'infinilabs/tongsuo-java-sdk'
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ref: ${{ inputs.BRANCH }}
          path: tongsuo-java-sdk

      - name: Build with Docker (Linux)
        if: runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker
        run: |
          set -e
          
          # Create build script that will run inside Docker
          cat > docker-build.sh << 'DOCKER_BUILD_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Docker Build Environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat /etc/os-release | grep PRETTY_NAME
          echo "GLIBC: $(ldd --version | head -n1)"
          echo "Architecture: $(uname -m)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Install dependencies
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y build-essential perl patchelf git wget curl openjdk-11-jdk-headless
          
          ARCH_PARAM="${{ matrix.arch }}"
          if [[ "$ARCH_PARAM" == "linux-aarch_64" ]]; then
            apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user-static
          fi
          
          # Build Tongsuo
          cd /build
          echo "Building Tongsuo ${{ inputs.TONGSUO_VERSION }}..."
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          # Configure based on inputs
          CONFIG_OPTS="${{ matrix.tongsuo_base_config }}"
          
          if [[ "${{ inputs.API_VERSION }}" != "default" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --api=${{ inputs.API_VERSION }}"
          fi
          
          if [[ "${{ inputs.ENABLE_NTLS }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-ntls"
          else
            CONFIG_OPTS="$CONFIG_OPTS no-ntls"
          fi
          
          if [[ "${{ inputs.ENABLE_SM2 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm2"
          fi
          
          if [[ "${{ inputs.ENABLE_SM3 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm3"
          fi
          
          if [[ "${{ inputs.ENABLE_SM4 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm4"
          fi
          
          if [[ "${{ inputs.ENABLE_DEBUG }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --debug"
          fi
          
          if [[ -n "${{ inputs.EXTRA_CONFIG_OPTS }}" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS ${{ inputs.EXTRA_CONFIG_OPTS }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tongsuo Configuration:"
          echo "  ./config $CONFIG_OPTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ./config $CONFIG_OPTS
          make -j$(nproc)
          make install_sw
          
          echo "âœ… Tongsuo built successfully"
          ls -lh /root/tongsuo/lib/
          
          # Build Java SDK
          cd /build/tongsuo-java-sdk
          
          # Copy build.gradle override
          cp -f /build/products/tongsuo/build.gradle ./
          
          export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
          ./gradlew -Pversion=${{ inputs.PUBLISH_VERSION }} \
                    -PcheckErrorQueue \
                    :tongsuo-openjdk:publishToMavenLocal
          
          echo "âœ… Published to Maven local repository"
          find /root/.m2/repository/com/infinilabs/tongsuo-openjdk -type f | head -20
          
          DOCKER_BUILD_SCRIPT
          
          chmod +x docker-build.sh
          
          # Run build in Docker
          docker run --rm \
            -v $GITHUB_WORKSPACE:/build \
            -v $HOME/.m2:/root/.m2 \
            -w /build \
            ${{ inputs.LINUX_DOCKER_IMAGE }} \
            /build/docker-build.sh

      - name: Show build environment info (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) }}
        shell: bash
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Build Environment Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "Distribution: $(lsb_release -d | cut -f2-)"
            echo "GLIBC Version: $(ldd --version | head -n1)"
            echo ""
            echo "âš ï¸  Binaries built on this system require GLIBC $(ldd --version | head -n1 | grep -oE '[0-9]+\.[0-9]+$') or higher"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build Tongsuo (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) }}
        shell: bash
        run: |
          set -e
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Building Tongsuo"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Version: ${{ inputs.TONGSUO_VERSION }}"
          echo "  Platform: ${{ matrix.platform_name }}"
          echo "  API Version: ${{ inputs.API_VERSION }}"
          echo "  Features:"
          echo "    - NTLS: ${{ inputs.ENABLE_NTLS }}"
          echo "    - SM2: ${{ inputs.ENABLE_SM2 }}"
          echo "    - SM3: ${{ inputs.ENABLE_SM3 }}"
          echo "    - SM4: ${{ inputs.ENABLE_SM4 }}"
          echo "    - Debug: ${{ inputs.ENABLE_DEBUG }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          git clone --depth 1 --branch ${{ inputs.TONGSUO_VERSION }} https://github.com/Tongsuo-Project/Tongsuo.git
          cd Tongsuo
          
          if [[ -n "${{ matrix.cc_prefix }}" ]]; then
            export CC=${{ matrix.cc_prefix }}gcc
            export CXX=${{ matrix.cc_prefix }}g++
          fi
          
          # Build configuration from inputs
          CONFIG_OPTS="${{ matrix.tongsuo_base_config }}"
          
          # API Version (skip if 'default')
          if [[ "${{ inputs.API_VERSION }}" != "default" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --api=${{ inputs.API_VERSION }}"
          fi
          
          # Feature flags
          if [[ "${{ inputs.ENABLE_NTLS }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-ntls"
          else
            CONFIG_OPTS="$CONFIG_OPTS no-ntls"
          fi
          
          if [[ "${{ inputs.ENABLE_SM2 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm2"
          fi
          
          if [[ "${{ inputs.ENABLE_SM3 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm3"
          fi
          
          if [[ "${{ inputs.ENABLE_SM4 }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS enable-sm4"
          fi
          
          if [[ "${{ inputs.ENABLE_DEBUG }}" == "true" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS --debug"
          fi
          
          # Extra options
          if [[ -n "${{ inputs.EXTRA_CONFIG_OPTS }}" ]]; then
            CONFIG_OPTS="$CONFIG_OPTS ${{ inputs.EXTRA_CONFIG_OPTS }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Full config command:"
          echo "  ./config $CONFIG_OPTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ./config $CONFIG_OPTS
          
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
          make install_sw
          
          echo "TONGSUO_HOME=$HOME/tongsuo" >> $GITHUB_ENV
          
          # Show Tongsuo version and features
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tongsuo build completed:"
          $HOME/tongsuo/bin/openssl version
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build and publish JAR with custom groupId (Native)
        if: ${{ !(runner.os == 'Linux' && inputs.USE_DOCKER_BUILD && matrix.use_docker) }}
        shell: bash
        working-directory: tongsuo-java-sdk
        run: |
          set -e
          
          # Copy build.gradle override
          cp -f $GITHUB_WORKSPACE/products/tongsuo/build.gradle ./
          
          # Build and publish to Maven local repository
          ./gradlew -Pversion=${{ inputs.PUBLISH_VERSION }} \
                    -PcheckErrorQueue \
                    :tongsuo-openjdk:publishToMavenLocal
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Published to Maven local repository"
          find ~/.m2/repository/com/infinilabs/tongsuo-openjdk -type f | head -20

      - name: Upload Maven repository
        uses: actions/upload-artifact@v4
        with:
          name: maven-repo-${{ matrix.platform_name }}
          path: ~/.m2/repository/com/infinilabs/tongsuo-openjdk/${{ inputs.PUBLISH_VERSION }}/**/*
          retention-days: 7

  publish:
    name: Create Maven Central Bundle
    needs: build-all-platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v6

      - name: Setup bootstrap
        uses: ./containers/bootstrap

      - name: Run connect in background
        run: |
          connect -c "$GITHUB_WORKSPACE/.net.json" >/dev/null 2>&1 &
          echo "Connect started with pid $!"
          sleep 5

      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Download all Maven repositories
        uses: actions/download-artifact@v4
        with:
          path: maven-repos
          pattern: maven-repo-*
          merge-multiple: false

      - name: Merge Maven repositories
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          MERGED_REPO="$GITHUB_WORKSPACE/merged-repo"
          mkdir -p "$MERGED_REPO/$GROUP_PATH/$ARTIFACT_ID/$VERSION"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Merging Maven repositories from all platforms"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Copy all platform Maven repositories
          for repo_dir in maven-repos/maven-repo-*; do
            if [ -d "$repo_dir" ]; then
              platform=$(basename "$repo_dir" | sed 's/maven-repo-//')
              echo "ğŸ“¦ Merging platform: $platform"
              
              # Copy all files from this platform's repo
              if [ -d "$repo_dir" ]; then
                cp -rv "$repo_dir"/* "$MERGED_REPO/$GROUP_PATH/$ARTIFACT_ID/$VERSION/" || true
              fi
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Merged repository contents:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          find "$MERGED_REPO" -type f | head -50

      - name: Verify Maven Central requirements
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          REPO_PATH="$GITHUB_WORKSPACE/merged-repo/$GROUP_PATH/$ARTIFACT_ID/$VERSION"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verifying Maven Central bundle requirements"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Count required files
          JAR_COUNT=$(find "$REPO_PATH" -name "*.jar" ! -name "*javadoc*" ! -name "*sources*" | wc -l)
          POM_COUNT=$(find "$REPO_PATH" -name "*.pom" | wc -l)
          SOURCES_COUNT=$(find "$REPO_PATH" -name "*-sources.jar" | wc -l)
          JAVADOC_COUNT=$(find "$REPO_PATH" -name "*-javadoc.jar" | wc -l)
          ASC_COUNT=$(find "$REPO_PATH" -name "*.asc" | wc -l)
          
          echo "Main JARs:    $JAR_COUNT"
          echo "POM files:    $POM_COUNT"
          echo "Sources JARs: $SOURCES_COUNT"
          echo "Javadoc JARs: $JAVADOC_COUNT"
          echo "Signatures:   $ASC_COUNT"
          
          if [ "$POM_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No POM files found!"
            exit 1
          fi
          
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No JAR files found!"
            exit 1
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Bundle validation passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create Maven Central bundle ZIP
        run: |
          set -e
          
          VERSION="${{ inputs.PUBLISH_VERSION }}"
          GROUP_ID="com.infinilabs"
          ARTIFACT_ID="tongsuo-openjdk"
          GROUP_PATH=$(echo $GROUP_ID | tr '.' '/')
          
          cd "$GITHUB_WORKSPACE/merged-repo"
          
          # Create the ZIP bundle (Maven Central expects a specific structure)
          ZIP_NAME="tongsuo-openjdk-${VERSION}.zip"
          zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" "$GROUP_PATH"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Maven Central bundle created:"
          echo "   File: $ZIP_NAME"
          echo "   Size: $(du -h "$GITHUB_WORKSPACE/$ZIP_NAME" | cut -f1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload to Maven Central Portal
        run: |
          ZIP_FILE="$GITHUB_WORKSPACE/tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}.zip"
          
          if [ ! -f "$ZIP_FILE" ]; then
            echo "âŒ ERROR: ZIP file not found: $ZIP_FILE"
            exit 1
          fi
          
          echo "ğŸ“¤ Uploading bundle to Maven Central Portal"
          export ZIP_FILE_PATH="$ZIP_FILE"
          python3 $GITHUB_WORKSPACE/scripts/publish_central.py
        env:
          DEBUG: true
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: maven-central-bundle
          path: tongsuo-openjdk-${{ inputs.PUBLISH_VERSION }}.zip
          retention-days: 30

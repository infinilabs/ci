name: Test Environment Setup (Dry-Run)
defaults:
  run:
    shell: bash
env:
  TZ: Asia/Shanghai
  PNAME: cloud
  DNAME: agent
  GO_VERSION: ${{ vars.GO_VERSION }}
  NODEJS_VERSION: ${{ vars.NODEJS_VERSION }}
  PRE_RELEASE: ${{ vars.PRE_RELEASE }}
  RELEASE_URL: ${{ vars.RELEASE_URL }}
  SSH_GIT_REPO: ${{ secrets.SSH_GIT_REPO }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  SSH_CONFIG: ${{ secrets.SSH_CONFIG }}
  OSS_EP: ${{ secrets.OSS_EP }}
  OSS_AK: ${{ secrets.OSS_AK }}
  OSS_SK: ${{ secrets.OSS_SK }}
  OSS_BK: ${{ secrets.OSS_BK }}
  OSS_MODE: ${{ secrets.OSS_MODE }}
  LOCAL_HOST: ${{ secrets.LOCAL_HOST }}
  LOCAL_PORT: ${{ secrets.LOCAL_PORT }}
  CONNECT_SERVER: ${{ secrets.CONNECT_SERVER }}
  CONNECT_PORT: ${{ secrets.CONNECT_PORT }}
  CONNECT_KEY: ${{ secrets.CONNECT_KEY }}
  CONNECT_TIMEOUT: ${{ vars.CONNECT_TIMEOUT }}
  CONNECT_MODE: ${{ vars.CONNECT_MODE }}
  CONNECT_METHOD: ${{ secrets.CONNECT_METHOD }}
  PROXY_RELEASE_INFINILABS: ${{ secrets.PROXY_RELEASE_INFINILABS }}

on:
  workflow_dispatch:
    inputs:
      TEST_UPLOAD:
        description: 'Test upload file'
        required: false
        type: boolean
        default: false
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup bootstrap
        uses: ./containers/bootstrap

      - name: Upload Test Artifact
        if: ${{ inputs.TEST_UPLOAD == true }}
        run: |
          echo "This is a test artifact" > test-artifact.txt
          oss upload -c "$GITHUB_WORKSPACE/.oss.yml" -f test-artifact.txt -p $DNAME && \
          oss delete -c "$GITHUB_WORKSPACE/.oss.yml" -p $DNAME -k test-artifact.txt

      - name: Get github release versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_API_URL: https://api.github.com
          TNAME: elasticsearch
        run: |
          fetch_versions() {
            # $1: repo slug (e.g., "owner/repo") and $2: version regex
            curl -H "Authorization: Bearer $GH_TOKEN" "$GITHUB_API_URL/repos/$1/releases?per_page=10" \
              | jq -r --arg regex "$2" '
                  .[] | 
                  select(
                    .prerelease == false and 
                    .draft == false and 
                    (.tag_name | test($regex))
                  ) | 
                  .tag_name | sub("^v"; "")'
          }

          if [[ $TNAME == "elasticsearch" ]] ; then
            echo "Fetching versions for $TNAME..."
            LATEST_VERSION=$(fetch_versions "elastic/$TNAME" "^v[0-9]+\\.[0-9]+\\.[0-9]+(\\.[0-9]+)?$")
            echo "$LATEST_VERSION" > /tmp/all_versions
          else
            LATEST_VERSION=$(fetch_versions "$TNAME-project/$TNAME" "^[0-9]+\\.[0-9]+\\.[0-9]+(\\.[0-9]+)?$")
            echo "$LATEST_VERSION" > /tmp/all_versions
          fi
          
          # filter versions
          > /tmp/versions
          if [[ $TNAME == "elasticsearch" ]] ; then
            while IFS= read -r ver; do
                MAJOR_VERSION=$(echo "$ver" | cut -d '.' -f 1)
                if [[ "$MAJOR_VERSION" -ge 9 ]]; then
                  echo "$ver" >> /tmp/versions
                fi
            done < /tmp/all_versions
          else
            while IFS= read -r ver; do
              MAJOR_VERSION=$(echo "$ver" | cut -d '.' -f 1)
              if [[ "$MAJOR_VERSION" -ge 3 ]]; then
                echo "$ver" >> /tmp/versions
              fi
            done < /tmp/all_versions
          fi
          cat /tmp/versions

      - name: Setup ${{ env.PNAME }} env
        run: |
          source $GITHUB_WORKSPACE/scripts/go-init.sh
          if [[ "$(echo "${{ vars.PRE_RELEASE }}" | tr '[:upper:]' '[:lower:]')" == "true" ]]; then
            grep -wq "pre" $GITHUB_WORKSPACE/.oss.yml || echo "pre: true" >> $GITHUB_WORKSPACE/.oss.yml
          fi
          echo WORK=$WORK >> $GITHUB_ENV
          echo WORKBASE=$WORKBASE >> $GITHUB_ENV
          echo PNAME=${{ env.PNAME }} >> $GITHUB_ENV
          echo PATH=$PATH:$GITHUB_WORKSPACE/tools >> $GITHUB_ENV
